<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿å–å¾—çŠ¶æ³ - Yobun</title>
    <script src="/js/status-header.js"></script>
    <script src="/js/config.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-green: #3fb950;
            --accent-yellow: #d29922;
            --accent-red: #f85149;
            --accent-blue: #58a6ff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }
        
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        label {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        input[type="date"], select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 8px 12px;
            font-size: 14px;
        }
        
        button {
            background-color: var(--accent-blue);
            border: none;
            border-radius: 6px;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button.btn-danger {
            background-color: var(--accent-red);
        }
        
        button.btn-warning {
            background-color: var(--accent-yellow);
            color: #000;
        }
        
        button.btn-secondary {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .summary-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }
        
        .summary-card h3 {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .summary-card .value {
            font-size: 24px;
            font-weight: 600;
        }
        
        .summary-card.success .value { color: var(--accent-green); }
        .summary-card.warning .value { color: var(--accent-yellow); }
        .summary-card.error .value { color: var(--accent-red); }
        
        .section {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .table-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
        }
        
        th.hole-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 8px 4px;
            font-size: 12px;
            min-width: 40px;
            text-align: center;
        }
        
        th.hole-header.priority {
            background-color: #1f2d1f;
        }
        
        tr:hover {
            background-color: var(--bg-tertiary);
        }
        
        .status-cell {
            text-align: center;
            font-size: 12px;
        }
        
        .status-ok {
            color: var(--accent-green);
        }
        
        .status-missing {
            color: var(--text-secondary);
        }
        
        .status-error {
            color: var(--accent-red);
        }
        
        .date-cell {
            font-family: monospace;
            white-space: nowrap;
        }
        
        .loading {
            text-align: center;
            padding: 48px;
            color: var(--text-secondary);
        }
        
        .error-message {
            background-color: rgba(248, 81, 73, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
            color: var(--accent-red);
        }
        
        .success-message {
            background-color: rgba(63, 185, 80, 0.1);
            border: 1px solid var(--accent-green);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
            color: var(--accent-green);
        }
        
        .legend {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .lock-panel {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
        }
        
        .lock-panel.locked {
            background-color: rgba(210, 153, 34, 0.2);
            border: 1px solid var(--accent-yellow);
        }
        
        .lock-info {
            flex: 1;
        }
        
        .lock-info .lock-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .lock-info .lock-detail {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .delete-form {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal h3 {
            margin-bottom: 16px;
        }
        
        .modal p {
            margin-bottom: 24px;
            color: var(--text-secondary);
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            th.hole-header {
                font-size: 10px;
                min-width: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ãƒ‡ãƒ¼ã‚¿å–å¾—çŠ¶æ³</h1>
            <nav style="display: flex; gap: 16px;">
                <a href="/failures" style="color: var(--accent-yellow); text-decoration: none;">å¤±æ•—ç®¡ç†</a>
                <a href="/schedule" style="color: var(--accent-blue); text-decoration: none;">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</a>
                <a href="/datamart" style="color: var(--accent-blue); text-decoration: none;">ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆ</a>
            </nav>
        </header>
        
        <!-- ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ” ãƒ­ãƒƒã‚¯çŠ¶æ…‹</h2>
            </div>
            <div id="lockPanel" class="lock-panel">
                <div class="lock-info">
                    <div class="lock-title" id="lockTitle">ç¢ºèªä¸­...</div>
                    <div class="lock-detail" id="lockDetail"></div>
                </div>
                <button id="forceUnlockBtn" class="btn-danger" style="display: none;">å¼·åˆ¶è§£é™¤</button>
            </div>
        </div>
        
        <!-- æ¤œç´¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ” æ¤œç´¢æ¡ä»¶</h2>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label for="startDate">é–‹å§‹æ—¥:</label>
                    <input type="date" id="startDate">
                </div>
                <div class="control-group">
                    <label for="endDate">çµ‚äº†æ—¥:</label>
                    <input type="date" id="endDate">
                </div>
                <button id="searchBtn">æ¤œç´¢</button>
                <button id="refreshBtn" class="btn-secondary">æ›´æ–°</button>
            </div>
        </div>
        
        <div id="messageContainer"></div>
        
        <!-- ã‚µãƒãƒªãƒ¼ -->
        <div class="summary" id="summaryContainer">
            <div class="summary-card">
                <h3>å¯¾è±¡æ—¥æ•°</h3>
                <div class="value" id="totalDates">-</div>
            </div>
            <div class="summary-card success">
                <h3>å®Œå…¨å–å¾—</h3>
                <div class="value" id="allComplete">-</div>
            </div>
            <div class="summary-card warning">
                <h3>å„ªå…ˆåº—èˆ—å®Œäº†</h3>
                <div class="value" id="priorityComplete">-</div>
            </div>
            <div class="summary-card">
                <h3>ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</h3>
                <div class="value" id="totalRecords">-</div>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ—‘ï¸ ç”Ÿãƒ‡ãƒ¼ã‚¿å‰Šé™¤</h2>
            </div>
            <div class="delete-form">
                <div class="form-group">
                    <label for="deleteStartDate">é–‹å§‹æ—¥:</label>
                    <input type="date" id="deleteStartDate">
                </div>
                <div class="form-group">
                    <label for="deleteEndDate">çµ‚äº†æ—¥:</label>
                    <input type="date" id="deleteEndDate">
                </div>
                <div class="form-group">
                    <label for="deleteHole">åº—èˆ—:</label>
                    <select id="deleteHole">
                        <option value="">å…¨åº—èˆ—</option>
                    </select>
                </div>
                <button id="deleteBtn" class="btn-danger">å‰Šé™¤</button>
            </div>
        </div>
        
        <!-- å†å–å¾—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ”„ ãƒ‡ãƒ¼ã‚¿å†å–å¾—</h2>
            </div>
            <div class="delete-form">
                <div class="form-group">
                    <label for="rescrapeStartDate">é–‹å§‹æ—¥:</label>
                    <input type="date" id="rescrapeStartDate">
                </div>
                <div class="form-group">
                    <label for="rescrapeEndDate">çµ‚äº†æ—¥:</label>
                    <input type="date" id="rescrapeEndDate">
                </div>
                <div class="form-group">
                    <label for="rescrapeHole">åº—èˆ—:</label>
                    <select id="rescrapeHole">
                        <option value="">å…¨åº—èˆ—</option>
                    </select>
                </div>
                <button id="rescrapeBtn" class="btn-warning">å†å–å¾—</button>
            </div>
            <!-- å†å–å¾—é€²æ—è¡¨ç¤º -->
            <div id="rescrapeProgress" style="display: none; margin-top: 16px;">
                <div style="background-color: var(--bg-tertiary); border-radius: 8px; overflow: hidden; height: 24px; margin-bottom: 8px;">
                    <div id="rescrapeProgressBar" style="background-color: var(--accent-blue); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="rescrapeProgressMessage" style="font-size: 14px; color: var(--text-secondary);"></div>
            </div>
        </div>
        
        <!-- å‡¡ä¾‹ -->
        <div class="legend">
            <div class="legend-item">
                <span class="status-ok">â—</span> å–å¾—æ¸ˆ
            </div>
            <div class="legend-item">
                <span class="status-missing">â—‹</span> æœªå–å¾—
            </div>
            <div class="legend-item">
                <span style="background-color: #1f2d1f; padding: 2px 8px; border-radius: 4px;">å„ªå…ˆåº—èˆ—</span>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="table-container">
            <table id="dataTable">
                <thead id="tableHead">
                    <tr>
                        <th>æ—¥ä»˜</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td class="loading" colspan="100">èª­ã¿è¾¼ã¿ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal">
            <h3 id="modalTitle">ç¢ºèª</h3>
            <p id="modalMessage"></p>
            <div class="modal-actions">
                <button id="modalCancelBtn" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modalConfirmBtn" class="btn-danger">å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>
    
    <script>
        // çŠ¶æ…‹ç®¡ç†
        let holes = [];
        let currentModalAction = null;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ã‚’è¨­å®š
        function setDefaultDates() {
            const today = getJSTDate(0);
            
            // æ¤œç´¢ç”¨
            const searchDays = CONFIG.defaultDateRanges.dashboard;
            document.getElementById('startDate').value = getJSTDate(-searchDays);
            document.getElementById('endDate').value = today;
            
            // å‰Šé™¤ç”¨ï¼ˆèª¤æ“ä½œé˜²æ­¢ã®ãŸã‚çŸ­ã‚ï¼‰
            const deleteDays = CONFIG.defaultDateRanges.delete;
            document.getElementById('deleteStartDate').value = getJSTDate(-deleteDays);
            document.getElementById('deleteEndDate').value = today;
            
            // å†å–å¾—ç”¨
            const rescrapeDays = CONFIG.defaultDateRanges.rescrape;
            document.getElementById('rescrapeStartDate').value = getJSTDate(-rescrapeDays);
            document.getElementById('rescrapeEndDate').value = today;
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('searchBtn').addEventListener('click', fetchData);
        document.getElementById('refreshBtn').addEventListener('click', () => {
            fetchData();
            fetchLockStatus();
            checkRescrapeStatus();
        });
        document.getElementById('forceUnlockBtn').addEventListener('click', showForceUnlockConfirm);
        document.getElementById('deleteBtn').addEventListener('click', showDeleteConfirm);
        document.getElementById('rescrapeBtn').addEventListener('click', showRescrapeConfirm);
        document.getElementById('modalCancelBtn').addEventListener('click', hideModal);
        document.getElementById('modalConfirmBtn').addEventListener('click', executeModalAction);
        
        // åˆæœŸåŒ–ï¼ˆæ—¥ä»˜è¨­å®šå¾Œã«ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰
        (async () => {
            await setDefaultDates();
            fetchData();
            fetchLockStatus();
        })();
        
        // å®šæœŸçš„ã«ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’æ›´æ–°
        setInterval(fetchLockStatus, 30000);
        
        async function fetchLockStatus() {
            try {
                const response = await fetch('/api/lock');
                const data = await response.json();
                
                const lockPanel = document.getElementById('lockPanel');
                const lockTitle = document.getElementById('lockTitle');
                const lockDetail = document.getElementById('lockDetail');
                const forceUnlockBtn = document.getElementById('forceUnlockBtn');
                
                if (data.locked) {
                    lockPanel.className = 'lock-panel locked';
                    lockTitle.textContent = 'ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­';
                    const env = data.status?.environment || 'ä¸æ˜';
                    const hours = data.status?.ageHours || 0;
                    const mins = data.status?.ageMinutes || 0;
                    const mode = data.status?.jobMode || 'ä¸æ˜';
                    lockDetail.textContent = `${env} (${mode}) - çµŒéæ™‚é–“: ${hours}æ™‚é–“${mins}åˆ†`;
                    forceUnlockBtn.style.display = 'block';
                } else {
                    lockPanel.className = 'lock-panel';
                    lockTitle.textContent = 'ğŸ”“ ãƒ­ãƒƒã‚¯ãªã—';
                    lockDetail.textContent = 'ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚’å®Ÿè¡Œã§ãã¾ã™';
                    forceUnlockBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('ãƒ­ãƒƒã‚¯çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        async function fetchData() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            if (!start || !end) {
                showError('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td class="loading" colspan="100">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
            
            try {
                const response = await fetch(`/api/data-status?start=${start}&end=${end}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                holes = data.holes;
                updateHoleSelector();
                renderData(data);
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ä¸Šæ›¸ãã—ãªã„ï¼ˆå‰Šé™¤æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã©ã‚’ä¿æŒã™ã‚‹ãŸã‚ï¼‰
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showError(`ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                tableBody.innerHTML = '<tr><td class="loading" colspan="100">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
            }
        }
        
        function updateHoleSelector() {
            const selectors = ['deleteHole', 'rescrapeHole'];
            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                select.innerHTML = '<option value="">å…¨åº—èˆ—</option>';
                holes.forEach(hole => {
                    const option = document.createElement('option');
                    option.value = hole.name;
                    option.textContent = hole.name;
                    select.appendChild(option);
                });
            });
        }
        
        function renderData(data) {
            // ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
            document.getElementById('totalDates').textContent = data.summary.totalDates;
            document.getElementById('allComplete').textContent = data.summary.allCompleteDates;
            document.getElementById('priorityComplete').textContent = data.summary.priorityCompleteDates;
            
            const totalRecords = data.data.reduce((sum, d) => sum + d.totalCount, 0);
            document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ§‹ç¯‰
            const tableHead = document.getElementById('tableHead');
            const headerRow = tableHead.querySelector('tr');
            headerRow.innerHTML = '<th>æ—¥ä»˜</th>';
            
            data.holes.forEach(hole => {
                const th = document.createElement('th');
                th.className = 'hole-header' + (hole.priority === 'high' ? ' priority' : '');
                th.textContent = hole.name.replace('åº—', '');
                headerRow.appendChild(th);
            });
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ã‚’æ§‹ç¯‰
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            data.data.forEach(dateData => {
                const tr = document.createElement('tr');
                
                // æ—¥ä»˜ã‚»ãƒ«
                const dateTd = document.createElement('td');
                dateTd.className = 'date-cell';
                dateTd.textContent = dateData.date;
                tr.appendChild(dateTd);
                
                // å„åº—èˆ—ã®ã‚»ãƒ«
                data.holes.forEach(hole => {
                    const td = document.createElement('td');
                    td.className = 'status-cell';
                    
                    const holeData = dateData.holes[hole.name];
                    if (holeData && holeData.count > 0) {
                        td.className += ' status-ok';
                        td.textContent = `â— ${holeData.count}`;
                        td.title = `æœ€çµ‚æ›´æ–°: ${holeData.lastUpdated}`;
                    } else {
                        td.className += ' status-missing';
                        td.textContent = 'â—‹';
                    }
                    
                    tr.appendChild(td);
                });
                
                tableBody.appendChild(tr);
            });
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        function showModal(title, message, action) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            currentModalAction = action;
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function hideModal() {
            document.getElementById('confirmModal').classList.remove('active');
            currentModalAction = null;
        }
        
        function executeModalAction() {
            if (currentModalAction) {
                currentModalAction();
            }
            hideModal();
        }
        
        function showForceUnlockConfirm() {
            showModal(
                'âš ï¸ ãƒ­ãƒƒã‚¯å¼·åˆ¶è§£é™¤',
                'æœ¬å½“ã«ãƒ­ãƒƒã‚¯ã‚’å¼·åˆ¶è§£é™¤ã—ã¾ã™ã‹ï¼Ÿå®Ÿè¡Œä¸­ã®å‡¦ç†ãŒç«¶åˆã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚',
                forceUnlock
            );
        }
        
        async function forceUnlock() {
            try {
                const response = await fetch('/api/lock', { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã—ãŸ');
                } else {
                    showError('ãƒ­ãƒƒã‚¯è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
                }
                
                fetchLockStatus();
            } catch (error) {
                console.error('ãƒ­ãƒƒã‚¯è§£é™¤ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ­ãƒƒã‚¯è§£é™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        function showDeleteConfirm() {
            const startDate = document.getElementById('deleteStartDate').value;
            const endDate = document.getElementById('deleteEndDate').value;
            const hole = document.getElementById('deleteHole').value;
            
            if (!startDate || !endDate) {
                showError('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            const holeText = hole || 'å…¨åº—èˆ—';
            showModal(
                'âš ï¸ ç”Ÿãƒ‡ãƒ¼ã‚¿å‰Šé™¤',
                `ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\n\næœŸé–“: ${startDate} ã€œ ${endDate}\nåº—èˆ—: ${holeText}`,
                deleteData
            );
        }
        
        async function deleteData() {
            const startDate = document.getElementById('deleteStartDate').value;
            const endDate = document.getElementById('deleteEndDate').value;
            const hole = document.getElementById('deleteHole').value;
            
            try {
                const response = await fetch('/api/data-status/raw', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ startDate, endDate, hole: hole || null }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let message = `å‰Šé™¤å®Œäº†: SQLite ${data.deleted.sqlite}ä»¶, BigQuery ${data.deleted.bigquery}ä»¶`;
                    if (data.warnings && data.warnings.length > 0) {
                        message += `\nè­¦å‘Š: ${data.warnings.map(w => `${w.date}: ${w.error}`).join(', ')}`;
                    }
                    showSuccess(message);
                    // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã¯å°‘ã—é…å»¶ã•ã›ã¦ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹æ™‚é–“ã‚’ç¢ºä¿
                    setTimeout(() => {
                        fetchData();
                    }, 1000);
                } else {
                    showError('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                }
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showError('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // å†å–å¾—é–¢é€£
        let rescrapeStatusInterval = null;
        
        function showRescrapeConfirm() {
            const startDate = document.getElementById('rescrapeStartDate').value;
            const endDate = document.getElementById('rescrapeEndDate').value;
            const hole = document.getElementById('rescrapeHole').value;
            
            if (!startDate || !endDate) {
                showError('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            const holeText = hole || 'å…¨åº—èˆ—';
            showModal(
                'ğŸ”„ ãƒ‡ãƒ¼ã‚¿å†å–å¾—',
                `ä»¥ä¸‹ã®æ¡ä»¶ã§ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¾ã™ã€‚ï¼ˆæ©Ÿç¨®æ•°ãŒç•°ãªã‚‹å ´åˆã®ã¿å†å–å¾—ï¼‰\n\næœŸé–“: ${startDate} ã€œ ${endDate}\nåº—èˆ—: ${holeText}`,
                startRescrape
            );
        }
        
        async function startRescrape() {
            const startDate = document.getElementById('rescrapeStartDate').value;
            const endDate = document.getElementById('rescrapeEndDate').value;
            const hole = document.getElementById('rescrapeHole').value;
            
            try {
                const response = await fetch('/util/force-rescrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        startDate, 
                        endDate, 
                        hole: hole || null
                    }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showSuccess(`å†å–å¾—ã‚’é–‹å§‹ã—ã¾ã—ãŸ: ${data.params.startDate} ã€œ ${data.params.endDate}`);
                    document.getElementById('rescrapeBtn').disabled = true;
                    startRescrapeStatusCheck();
                } else {
                    showError('å†å–å¾—ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || data.message));
                }
            } catch (error) {
                console.error('å†å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showError('å†å–å¾—ã®é–‹å§‹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        function startRescrapeStatusCheck() {
            const progressContainer = document.getElementById('rescrapeProgress');
            const progressBar = document.getElementById('rescrapeProgressBar');
            const progressMessage = document.getElementById('rescrapeProgressMessage');
            
            progressContainer.style.display = 'block';
            
            rescrapeStatusInterval = setInterval(async () => {
                try {
                    const response = await fetch('/util/force-rescrape/status');
                    const status = await response.json();
                    
                    if (status.progress.total > 0) {
                        const progress = (status.progress.current / status.progress.total) * 100;
                        progressBar.style.width = `${progress}%`;
                    }
                    
                    progressMessage.textContent = status.progress.message;
                    
                    if (!status.isRunning) {
                        clearInterval(rescrapeStatusInterval);
                        rescrapeStatusInterval = null;
                        document.getElementById('rescrapeBtn').disabled = false;
                        
                        if (status.lastError) {
                            progressBar.style.backgroundColor = 'var(--accent-red)';
                            showError('å†å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + status.lastError);
                        } else {
                            progressBar.style.backgroundColor = 'var(--accent-green)';
                            showSuccess('å†å–å¾—ãŒå®Œäº†ã—ã¾ã—ãŸ');
                            // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                            setTimeout(() => {
                                fetchData();
                            }, 1000);
                        }
                    }
                } catch (error) {
                    clearInterval(rescrapeStatusInterval);
                    rescrapeStatusInterval = null;
                    progressMessage.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                    document.getElementById('rescrapeBtn').disabled = false;
                }
            }, 1000);
        }
        
        async function checkRescrapeStatus() {
            try {
                const response = await fetch('/util/force-rescrape/status');
                const status = await response.json();
                
                if (status.isRunning && !rescrapeStatusInterval) {
                    document.getElementById('rescrapeBtn').disabled = true;
                    startRescrapeStatusCheck();
                }
            } catch (error) {
                console.error('å†å–å¾—çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // åˆå›èª­ã¿è¾¼ã¿æ™‚ã«å†å–å¾—çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        checkRescrapeStatus();
        
        function showError(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }
        
        function showSuccess(message) {
            const container = document.getElementById('messageContainer');
            // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
            const formattedMessage = message.replace(/\n/g, '<br>');
            container.innerHTML = `<div class="success-message">${formattedMessage}</div>`;
            setTimeout(hideMessage, 10000); // 10ç§’ã«å»¶é•·ï¼ˆè­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å«ã‚€ãŸã‚ï¼‰
        }
        
        function hideMessage() {
            document.getElementById('messageContainer').innerHTML = '';
        }
    </script>
</body>
</html>
