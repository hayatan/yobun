<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆç®¡ç† - Yobun</title>
    <script src="/js/status-header.js"></script>
    <script src="/js/config.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-green: #3fb950;
            --accent-yellow: #d29922;
            --accent-red: #f85149;
            --accent-blue: #58a6ff;
            --accent-purple: #a371f7;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }
        
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        label {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        input[type="date"], select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 8px 12px;
            font-size: 14px;
        }
        
        button {
            background-color: var(--accent-blue);
            border: none;
            border-radius: 6px;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button.btn-danger {
            background-color: var(--accent-red);
        }
        
        button.btn-warning {
            background-color: var(--accent-yellow);
            color: #000;
        }
        
        button.btn-secondary {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }
        
        button.btn-purple {
            background-color: var(--accent-purple);
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .summary-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }
        
        .summary-card h3 {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .summary-card .value {
            font-size: 24px;
            font-weight: 600;
        }
        
        .summary-card.success .value { color: var(--accent-green); }
        .summary-card.warning .value { color: var(--accent-yellow); }
        
        .section {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .table-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
        }
        
        th.hole-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 8px 4px;
            font-size: 12px;
            min-width: 40px;
            text-align: center;
        }
        
        th.hole-header.priority {
            background-color: #1f2d1f;
        }
        
        tr:hover {
            background-color: var(--bg-tertiary);
        }
        
        .status-cell {
            text-align: center;
            font-size: 12px;
        }
        
        .status-ok {
            color: var(--accent-green);
        }
        
        .status-missing {
            color: var(--text-secondary);
        }
        
        .date-cell {
            font-family: monospace;
            white-space: nowrap;
        }
        
        .loading {
            text-align: center;
            padding: 48px;
            color: var(--text-secondary);
        }
        
        .error-message {
            background-color: rgba(248, 81, 73, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
            color: var(--accent-red);
        }
        
        .success-message {
            background-color: rgba(63, 185, 80, 0.1);
            border: 1px solid var(--accent-green);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 24px;
            color: var(--accent-green);
        }
        
        .warning-box {
            background-color: rgba(210, 153, 34, 0.1);
            border: 1px solid var(--accent-yellow);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            color: var(--accent-yellow);
            font-size: 14px;
        }
        
        .warning-box strong {
            display: block;
            margin-bottom: 8px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .job-status {
            padding: 16px;
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .job-status.running {
            background-color: rgba(88, 166, 255, 0.1);
            border: 1px solid var(--accent-blue);
        }
        
        .job-status .status-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .job-status .status-detail {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal h3 {
            margin-bottom: 16px;
        }
        
        .modal p {
            margin-bottom: 24px;
            color: var(--text-secondary);
            white-space: pre-wrap;
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            th.hole-header {
                font-size: 10px;
                min-width: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆç®¡ç†</h1>
            <nav style="display: flex; gap: 16px;">
                <a href="/dashboard" style="color: var(--accent-blue); text-decoration: none;">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                <a href="/failures" style="color: var(--accent-yellow); text-decoration: none;">å¤±æ•—ç®¡ç†</a>
                <a href="/schedule" style="color: var(--accent-blue); text-decoration: none;">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</a>
            </nav>
        </header>
        
        <!-- ã‚¸ãƒ§ãƒ–çŠ¶æ…‹ -->
        <div id="jobStatus" class="job-status" style="display: none;">
            <div class="status-title" id="jobStatusTitle">-</div>
            <div class="status-detail" id="jobStatusDetail">-</div>
        </div>
        
        <!-- æ¤œç´¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ” æ¤œç´¢æ¡ä»¶</h2>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label for="startDate">é–‹å§‹æ—¥:</label>
                    <input type="date" id="startDate">
                </div>
                <div class="control-group">
                    <label for="endDate">çµ‚äº†æ—¥:</label>
                    <input type="date" id="endDate">
                </div>
                <button id="searchBtn">æ¤œç´¢</button>
                <button id="refreshBtn" class="btn-secondary">æ›´æ–°</button>
            </div>
        </div>
        
        <div id="messageContainer"></div>
        
        <!-- ã‚µãƒãƒªãƒ¼ -->
        <div class="summary">
            <div class="summary-card">
                <h3>å¯¾è±¡æ—¥æ•°</h3>
                <div class="value" id="totalDates">-</div>
            </div>
            <div class="summary-card success">
                <h3>ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</h3>
                <div class="value" id="totalRecords">-</div>
            </div>
            <div class="summary-card warning">
                <h3>å‹ã¡å°æ•°</h3>
                <div class="value" id="totalWins">-</div>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆå‰Šé™¤</h2>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="deleteDate">æ—¥ä»˜:</label>
                    <input type="date" id="deleteDate">
                </div>
                <div class="form-group">
                    <label for="deleteHole">åº—èˆ—:</label>
                    <select id="deleteHole">
                        <option value="">å…¨åº—èˆ—</option>
                    </select>
                </div>
                <button id="deleteBtn" class="btn-danger">å‰Šé™¤</button>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆå†å®Ÿè¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <div class="section-header">
                <h2>ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆå†å®Ÿè¡Œ</h2>
            </div>
            <div class="warning-box">
                <strong>âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …</strong>
                æŒ‡å®šã—ãŸæ—¥ä»˜ã® <strong>1æ—¥å‰</strong> ãŒãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆã® target_date ã«ãªã‚Šã¾ã™ã€‚<br>
                ä¾‹: 2026-01-15 ã‚’æŒ‡å®š â†’ ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆã® target_date = 2026-01-14<br>
                <br>
                ã“ã‚Œã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆãŒã€Œå®Ÿè¡Œæ—¥ã®å‰æ—¥ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆã™ã‚‹ãŸã‚ã§ã™ã€‚<br>
                æ—¥æœ¬æ™‚é–“ï¼ˆJSTï¼‰åŸºæº–ã§è¨ˆç®—ã•ã‚Œã¾ã™ã€‚
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="runStartDate">é–‹å§‹æ—¥:</label>
                    <input type="date" id="runStartDate">
                </div>
                <div class="form-group">
                    <label for="runEndDate">çµ‚äº†æ—¥:</label>
                    <input type="date" id="runEndDate">
                </div>
                <button id="runBtn" class="btn-purple">å†å®Ÿè¡Œ</button>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="table-container">
            <table id="dataTable">
                <thead id="tableHead">
                    <tr>
                        <th>æ—¥ä»˜</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td class="loading" colspan="100">èª­ã¿è¾¼ã¿ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal">
            <h3 id="modalTitle">ç¢ºèª</h3>
            <p id="modalMessage"></p>
            <div class="modal-actions">
                <button id="modalCancelBtn" class="btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modalConfirmBtn" class="btn-danger">å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>
    
    <script>
        // çŠ¶æ…‹ç®¡ç†
        let holes = [];
        let currentModalAction = null;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ã‚’è¨­å®š
        function setDefaultDates() {
            const today = getJSTDate(0);
            
            // æ¤œç´¢ç”¨
            const searchDays = CONFIG.defaultDateRanges.datamart;
            document.getElementById('startDate').value = getJSTDate(-searchDays);
            document.getElementById('endDate').value = today;
            
            // å‰Šé™¤ç”¨ï¼ˆèª¤æ“ä½œé˜²æ­¢ã®ãŸã‚çŸ­ã‚ï¼‰
            const deleteDays = CONFIG.defaultDateRanges.delete;
            document.getElementById('deleteDate').value = getJSTDate(-deleteDays);
            
            // å†å®Ÿè¡Œç”¨
            const runDays = CONFIG.defaultDateRanges.datamartRun;
            document.getElementById('runStartDate').value = getJSTDate(-runDays);
            document.getElementById('runEndDate').value = today;
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('searchBtn').addEventListener('click', fetchData);
        document.getElementById('refreshBtn').addEventListener('click', () => {
            fetchData();
            fetchJobStatus();
        });
        document.getElementById('deleteBtn').addEventListener('click', showDeleteConfirm);
        document.getElementById('runBtn').addEventListener('click', showRunConfirm);
        document.getElementById('modalCancelBtn').addEventListener('click', hideModal);
        document.getElementById('modalConfirmBtn').addEventListener('click', executeModalAction);
        
        // åˆæœŸåŒ–ï¼ˆæ—¥ä»˜è¨­å®šå¾Œã«ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰
        (async () => {
            await setDefaultDates();
            fetchData();
            fetchJobStatus();
        })();
        
        // å®šæœŸçš„ã«ã‚¸ãƒ§ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
        setInterval(fetchJobStatus, 5000);
        
        async function fetchJobStatus() {
            try {
                const response = await fetch('/api/datamart/status/job');
                const data = await response.json();
                
                const statusDiv = document.getElementById('jobStatus');
                const statusTitle = document.getElementById('jobStatusTitle');
                const statusDetail = document.getElementById('jobStatusDetail');
                
                if (data.isRunning) {
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'job-status running';
                    statusTitle.textContent = 'ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆæ›´æ–°ä¸­...';
                    statusDetail.textContent = data.progress?.message || 'å‡¦ç†ä¸­...';
                } else if (data.lastError) {
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'job-status';
                    statusTitle.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼';
                    statusDetail.textContent = data.lastError;
                } else if (data.progress?.message && data.progress.message !== 'é–‹å§‹...') {
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'job-status';
                    statusTitle.textContent = 'âœ… å®Œäº†';
                    statusDetail.textContent = data.progress.message;
                } else {
                    statusDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('ã‚¸ãƒ§ãƒ–çŠ¶æ…‹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        async function fetchData() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            if (!start || !end) {
                showError('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td class="loading" colspan="100">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
            
            try {
                const response = await fetch(`/api/datamart/status?start=${start}&end=${end}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                holes = data.holes;
                updateHoleSelector();
                renderData(data);
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showError(`ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                tableBody.innerHTML = '<tr><td class="loading" colspan="100">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
            }
        }
        
        function updateHoleSelector() {
            const select = document.getElementById('deleteHole');
            select.innerHTML = '<option value="">å…¨åº—èˆ—</option>';
            holes.forEach(hole => {
                const option = document.createElement('option');
                option.value = hole.name;
                option.textContent = hole.name;
                select.appendChild(option);
            });
        }
        
        function renderData(data) {
            // ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
            document.getElementById('totalDates').textContent = data.summary.totalDates;
            document.getElementById('totalRecords').textContent = data.summary.totalRecords.toLocaleString();
            document.getElementById('totalWins').textContent = data.summary.totalWins.toLocaleString();
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ§‹ç¯‰
            const tableHead = document.getElementById('tableHead');
            const headerRow = tableHead.querySelector('tr');
            headerRow.innerHTML = '<th>æ—¥ä»˜</th><th>åˆè¨ˆ</th>';
            
            data.holes.forEach(hole => {
                const th = document.createElement('th');
                th.className = 'hole-header' + (hole.priority === 'high' ? ' priority' : '');
                th.textContent = hole.name.replace('åº—', '');
                headerRow.appendChild(th);
            });
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ã‚’æ§‹ç¯‰
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            data.data.forEach(dateData => {
                const tr = document.createElement('tr');
                
                // æ—¥ä»˜ã‚»ãƒ«
                const dateTd = document.createElement('td');
                dateTd.className = 'date-cell';
                dateTd.textContent = dateData.date;
                tr.appendChild(dateTd);
                
                // åˆè¨ˆã‚»ãƒ«
                const totalTd = document.createElement('td');
                totalTd.className = 'status-cell';
                totalTd.textContent = dateData.totalCount > 0 ? dateData.totalCount : '-';
                tr.appendChild(totalTd);
                
                // å„åº—èˆ—ã®ã‚»ãƒ«
                data.holes.forEach(hole => {
                    const td = document.createElement('td');
                    td.className = 'status-cell';
                    
                    const holeData = dateData.holes[hole.name];
                    if (holeData && holeData.count > 0) {
                        td.className += ' status-ok';
                        const winRate = Math.round((holeData.winCount / holeData.count) * 100);
                        td.textContent = `${holeData.count} (${winRate}%)`;
                        td.title = `å‹ã¡: ${holeData.winCount}å°\nå¹³å‡å·®æš: ${holeData.avgDiff}`;
                    } else {
                        td.className += ' status-missing';
                        td.textContent = '-';
                    }
                    
                    tr.appendChild(td);
                });
                
                tableBody.appendChild(tr);
            });
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        function showModal(title, message, action) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            currentModalAction = action;
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function hideModal() {
            document.getElementById('confirmModal').classList.remove('active');
            currentModalAction = null;
        }
        
        function executeModalAction() {
            if (currentModalAction) {
                currentModalAction();
            }
            hideModal();
        }
        
        function showDeleteConfirm() {
            const date = document.getElementById('deleteDate').value;
            const hole = document.getElementById('deleteHole').value;
            
            if (!date) {
                showError('æ—¥ä»˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            const holeText = hole || 'å…¨åº—èˆ—';
            showModal(
                'âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆå‰Šé™¤',
                `ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚\n\næ—¥ä»˜: ${date}\nåº—èˆ—: ${holeText}`,
                deleteData
            );
        }
        
        async function deleteData() {
            const date = document.getElementById('deleteDate').value;
            const hole = document.getElementById('deleteHole').value;
            
            try {
                const response = await fetch('/api/datamart/delete', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, hole: hole || null }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(`å‰Šé™¤å®Œäº†: ${data.deleted}ä»¶`);
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ™‚é–“ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚1ç§’å¾…ã£ã¦ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
                    setTimeout(fetchData, 1000);
                } else {
                    showError('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                }
            } catch (error) {
                console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showError('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        function showRunConfirm() {
            const startDate = document.getElementById('runStartDate').value;
            const endDate = document.getElementById('runEndDate').value;
            
            if (!startDate || !endDate) {
                showError('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
                return;
            }
            
            // 1æ—¥å‰ã®æ—¥ä»˜ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
            const targetStart = new Date(startDate);
            targetStart.setDate(targetStart.getDate() - 1);
            const targetEnd = new Date(endDate);
            targetEnd.setDate(targetEnd.getDate() - 1);
            
            showModal(
                'ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆå†å®Ÿè¡Œ',
                `ä»¥ä¸‹ã®æœŸé–“ã§ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆã‚’å†å®Ÿè¡Œã—ã¾ã™ã€‚\n\næŒ‡å®šæœŸé–“: ${startDate} ã€œ ${endDate}\nãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆã® target_date: ${targetStart.toISOString().split('T')[0]} ã€œ ${targetEnd.toISOString().split('T')[0]}\n\næ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼ˆMERGEã«ã‚ˆã‚‹æ›´æ–°ï¼‰ã€‚`,
                runDatamart
            );
        }
        
        async function runDatamart() {
            const startDate = document.getElementById('runStartDate').value;
            const endDate = document.getElementById('runEndDate').value;
            
            try {
                const response = await fetch('/api/datamart/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ startDate, endDate }),
                });
                
                const data = await response.json();
                
                if (response.status === 202) {
                    showSuccess('ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ãƒˆæ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
                    fetchJobStatus();
                } else {
                    showError('å†å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                }
            } catch (error) {
                console.error('å†å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
                showError('å†å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        function showError(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }
        
        function showSuccess(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="success-message">${message}</div>`;
            setTimeout(hideMessage, 10000); // 10ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
        }
        
        function hideMessage() {
            document.getElementById('messageContainer').innerHTML = '';
        }
    </script>
</body>
</html>
