# SQL ファイル修正ガイドライン

## ディレクトリ構造

```
sql/
├── AGENTS.md                          # このファイル（修正ガイドライン）
├── create_datamart_table.sql         # データマートテーブル作成DDL
├── datamart_machine_stats.sql        # データマート生成クエリ
└── analysis/                          # 分析クエリディレクトリ
    ├── README.md                      # 分析システムのドキュメント
    ├── recommendation_output.sql     # 狙い台一覧出力（複数店舗・機種対応）
    ├── recommendation_evaluation.sql # 狙い台選定方法の評価
    ├── scripts/                       # 分析スクリプト
    └── results/                       # 評価結果
```

---

## 基本原則

### 1. 整合性の維持

- **データマートの変更時**: `datamart_machine_stats.sql` を変更したら、必ず `analysis/README.md` の「1. データマート」セクションを更新する
- **分析クエリの変更時**: `analysis/*.sql` を変更したら、必ず `analysis/README.md` の該当セクションを更新する
- **新規クエリ追加時**: `analysis/README.md` の「4. クエリファイル一覧」に追加する

### 2. ドキュメントの更新

- クエリの動作や仕様を変更した場合は、必ず `analysis/README.md` を更新する
- 新しい機能を追加した場合は、使用方法を `analysis/README.md` に追記する
- パラメータを追加・変更した場合は、`analysis/README.md` に記載する

### 3. コメントの記述

- 複雑なロジックには必ずコメントを記述する
- CTE（Common Table Expression）には目的を記載する
- パラメータの説明はクエリ冒頭に記載する

---

## データマートの修正方法

### `datamart_machine_stats.sql` を修正する場合

#### 1. 集計期間の追加

新しい集計期間（例: `d14`、`prev_d14`）を追加する場合：

1. **`datamart_machine_stats.sql` の修正**
   - `stats_d14` CTE を追加（`stats_d3` などを参考）
   - `stats_prev_d14` CTE を追加（`stats_prev_d3` などを参考）
   - 最終SELECT文に `d14_*` と `prev_d14_*` カラムを追加
   - MERGE文のUPDATEとINSERTにカラムを追加

2. **`create_datamart_table.sql` の修正**
   - テーブル定義に `d14_*` と `prev_d14_*` カラムを追加

3. **`analysis/README.md` の更新**
   - 「1.4 集計期間の種類」セクションに新しい期間を追加
   - 「1.9 テーブル構造」セクションに新しいカラムを追加

#### 2. 集計項目の追加

新しい集計項目（例: `big_count`、`reg_count`）を追加する場合：

1. **`datamart_machine_stats.sql` の修正**
   - 各 `stats_*` CTE で新しい項目を集計
   - 最終SELECT文にカラムを追加
   - MERGE文のUPDATEとINSERTにカラムを追加

2. **`create_datamart_table.sql` の修正**
   - テーブル定義に新しいカラムを追加

3. **`analysis/README.md` の更新**
   - 「1.5 集計項目」セクションに新しい項目を追加
   - 「1.9 テーブル構造」セクションに新しいカラムを追加

#### 3. 台番マッピングの追加

新しい店舗の台番マッピングを追加する場合：

1. **`datamart_machine_stats.sql` の修正**
   - `machine_number_mapping` CTE に新しい店舗のマッピングを追加
   - `normalized_data` CTE のCASE文に新しい店舗の条件を追加

2. **`analysis/README.md` の更新**
   - 「1.7 台番マッピング」セクションに新しい店舗の説明を追加

#### 4. チェックリスト

データマートを修正したら、以下を確認：

- [ ] `datamart_machine_stats.sql` が正しく動作するか（構文エラーがないか）
- [ ] `create_datamart_table.sql` のテーブル定義と一致しているか
- [ ] `analysis/README.md` の「1. データマート」セクションが最新か
- [ ] 既存の分析クエリ（`analysis/*.sql`）が影響を受けないか

---

## 分析クエリの作成・修正方法

### 新しく分析クエリを作成する場合

#### 1. ファイルの配置

- 分析クエリは `sql/analysis/` ディレクトリに配置する
- ファイル名は `snake_case` で、機能を表す明確な名前を使用する
- 例: `trend_analysis.sql`、`machine_comparison.sql`

#### 2. クエリの構造

```sql
-- ============================================================================
-- [クエリ名]
-- ============================================================================
-- 
-- 【パラメータ定義】
--   以下のDECLARE文で定義した値を使用
-- ============================================================================
DECLARE target_hole STRING DEFAULT 'アイランド秋葉原店';
DECLARE target_machine STRING DEFAULT 'L+ToLOVEるダークネス';

-- 【分析目的】
--   このクエリで何を分析するかを記載

-- 【出力項目】
--   出力されるカラムとその意味を記載

-- ============================================================================

WITH 
-- 基本データの取得
base_data AS (
  SELECT ...
  FROM `yobun-450512.datamart.machine_stats`
  WHERE ...
),

-- 分析処理
analysis_result AS (
  SELECT ...
  FROM base_data
  ...
)

-- 最終出力
SELECT ...
FROM analysis_result
ORDER BY ...
```

#### 3. データマートの参照

- 分析クエリは `yobun-450512.datamart.machine_stats` テーブルを参照する
- 生データテーブル（`yobun-450512.slot_data.data_*`）は直接参照しない
- 集計期間は `prev_d*`（当日を含まない）と `d*`（当日を含む）を適切に使い分ける

#### 4. README の更新

1. **`analysis/README.md` の「4. クエリファイル一覧」に追加**
   ```markdown
   | ファイル | 用途 |
   |----------|------|
   | `new_analysis.sql` | 新しい分析の説明 |
   ```

2. **必要に応じて新しいセクションを追加**
   - クエリの使い方
   - パラメータの説明
   - 出力項目の説明
   - 使用例

#### 5. チェックリスト

新しい分析クエリを作成したら、以下を確認：

- [ ] クエリが正しく動作するか（構文エラーがないか）
- [ ] データマートのカラム名が正しいか
- [ ] パラメータの説明がクエリ冒頭に記載されているか
- [ ] `analysis/README.md` に追加されているか
- [ ] 出力項目の説明が記載されているか

### 既存の分析クエリを修正する場合

#### 1. パラメータの追加・変更

1. **クエリの修正**
   - `DECLARE` 文を追加・変更
   - クエリ冒頭のコメントにパラメータの説明を追加

2. **`analysis/README.md` の更新**
   - 該当クエリのセクションでパラメータの説明を更新

#### 2. 出力項目の追加・変更

1. **クエリの修正**
   - SELECT文に新しいカラムを追加
   - 必要に応じてCTEを追加・修正

2. **`analysis/README.md` の更新**
   - 該当クエリのセクションで出力項目の説明を更新

#### 3. ロジックの変更

1. **クエリの修正**
   - 変更箇所にコメントを追加（なぜ変更したか）

2. **`analysis/README.md` の更新**
   - 変更内容を反映
   - 動作が変わった場合は、使い方の説明も更新

#### 4. チェックリスト

既存の分析クエリを修正したら、以下を確認：

- [ ] クエリが正しく動作するか（構文エラーがないか）
- [ ] 既存の出力形式と互換性があるか（破壊的変更の場合は明記）
- [ ] `analysis/README.md` が最新か
- [ ] 変更内容がコメントに記載されているか

---

## README の更新方法

### `analysis/README.md` を更新する場合

#### 1. データマート関連の更新

- **セクション**: 「1. データマート」
- **更新タイミング**: `datamart_machine_stats.sql` または `create_datamart_table.sql` を変更した時
- **確認項目**:
  - 集計期間の説明が最新か
  - 集計項目の説明が最新か
  - テーブル構造が最新か
  - 実行方法が正しいか

#### 2. 分析クエリ関連の更新

- **セクション**: 「2. 戦略シミュレーション + 台番推薦」など、各クエリのセクション
- **更新タイミング**: `analysis/*.sql` を変更した時
- **確認項目**:
  - パラメータの説明が最新か
  - 出力項目の説明が最新か
  - 使い方が正しいか
  - クエリの構造が最新か

#### 3. 新規クエリ追加時の更新

- **セクション**: 「4. クエリファイル一覧」と新しいセクション
- **更新タイミング**: 新しい分析クエリを追加した時
- **確認項目**:
  - ファイル一覧に追加されているか
  - 使い方の説明が記載されているか
  - パラメータの説明が記載されているか
  - 出力項目の説明が記載されているか

#### 4. 整合性チェック

README を更新したら、以下を確認：

- [ ] 記載されているファイル名が実際に存在するか
- [ ] 記載されているカラム名が実際のテーブル定義と一致しているか
- [ ] 記載されているパラメータ名が実際のクエリと一致しているか
- [ ] 記載されている実行方法が正しいか
- [ ] 記載されている出力項目が実際のクエリの出力と一致しているか

---

## ベストプラクティス

### 1. 変更前の確認

- 変更を加える前に、既存のコードとドキュメントを確認する
- 影響範囲を把握する（他のクエリへの影響がないか）

### 2. 段階的な変更

- 大きな変更は小さな変更に分割する
- 各変更ごとに動作確認とドキュメント更新を行う

### 3. コメントの記述

- 複雑なロジックには必ずコメントを記述する
- 変更理由をコメントに記載する（特に既存ロジックを変更する場合）

### 4. テスト

- クエリを修正したら、必ず実行して動作確認する
- 出力結果が期待通りか確認する
- エラーが発生しないか確認する

### 5. ドキュメントの同期

- クエリの変更と同時にドキュメントも更新する
- 後回しにしない（忘れやすいため）

---

## トラブルシューティング

### よくある問題と対処法

#### 1. データマートのカラムが見つからない

- **原因**: テーブル定義とクエリのカラム名が不一致
- **対処**: `create_datamart_table.sql` のテーブル定義を確認し、正しいカラム名を使用する

#### 2. 分析クエリがエラーになる

- **原因**: データマートのカラム名が変更された、または存在しない
- **対処**: `datamart_machine_stats.sql` の最新のカラム定義を確認する

#### 3. README と実際の動作が違う

- **原因**: クエリを変更したが README を更新し忘れた
- **対処**: README を最新の状態に更新する

#### 4. パラメータが効かない

- **原因**: `DECLARE` 文の記述が間違っている、またはスコープが違う
- **対処**: `DECLARE` 文の位置と記述を確認する

---

## チェックリスト（変更時の最終確認）

クエリやドキュメントを変更したら、以下を確認：

### データマートの変更時

- [ ] `datamart_machine_stats.sql` が正しく動作する
- [ ] `create_datamart_table.sql` のテーブル定義と一致している
- [ ] `analysis/README.md` の「1. データマート」セクションが最新
- [ ] 既存の分析クエリが影響を受けない

### 分析クエリの変更時

- [ ] クエリが正しく動作する（構文エラーがない）
- [ ] データマートのカラム名が正しい
- [ ] パラメータの説明がクエリ冒頭に記載されている
- [ ] `analysis/README.md` が最新
- [ ] 出力項目の説明が記載されている

### 新規クエリ追加時

- [ ] クエリが正しく動作する
- [ ] データマートのカラム名が正しい
- [ ] パラメータの説明がクエリ冒頭に記載されている
- [ ] `analysis/README.md` の「4. クエリファイル一覧」に追加されている
- [ ] 使い方の説明が `analysis/README.md` に記載されている

---

## 参考資料

- `analysis/README.md`: 分析システムの詳細ドキュメント
- `datamart_machine_stats.sql`: データマート生成クエリの実装例
- `recommendation.sql`: 分析クエリの実装例

