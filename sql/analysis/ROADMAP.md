# 狙い台分析システム 開発ロードマップ

## 📋 プロジェクト概要

スロット台の高設定予測精度を向上させるため、複数の分析手法を開発・評価するプロジェクトです。
各手法は独立して開発・評価し、最終的にはアンサンブル（統合）することで、より堅牢な予測を目指します。

---

## 🗂️ ディレクトリ構造

```
sql/analysis/
├── README.md                           # 全体概要
├── ROADMAP.md                          # このファイル
├── strategy_matching/                  # Phase 1: 戦略マッチング（既存・完成）
│   ├── README.md
│   ├── recommendation_output.sql
│   ├── recommendation_output_説明文.md
│   ├── recommendation_evaluation.sql
│   ├── scripts/
│   └── results/
├── time_series/                        # Phase 2: 時系列パターン分析
│   ├── README.md
│   └── ...
├── correlation/                        # Phase 3: 台番相関分析
│   ├── README.md
│   └── ...
├── machine_learning/                   # Phase 4: 機械学習予測
│   ├── README.md
│   └── ...
└── ensemble/                           # Phase 5: アンサンブル統合
    ├── README.md
    └── ...
```

---

## 🚀 開発フェーズ

### Phase 1: 戦略マッチング手法 ✅ 完了

**ステータス**: 完了（運用中）

**概要**: 
事前定義した戦略条件（勝率・機械割・差枚ランキングの組み合わせ）に対する過去パフォーマンスを計算し、各台が該当する戦略のスコアをRMSで統合する手法。

**成果物**:
- `recommendation_output.sql`: 狙い台一覧出力クエリ
- `recommendation_evaluation.sql`: 評価クエリ
- 評価結果: 複数店舗・機種で検証済み

**主な特徴**:
- 解釈性が高い（どの戦略が効いているか分かる）
- 事前定義した条件に依存（新しいパターンを自動検出できない）
- 時間的なパターンを捉えにくい

---

### Phase 2: 時系列パターン分析 📅 次期開発

**ステータス**: 計画中

**概要**:
各台の過去データを時系列として分析し、「高設定投入の周期性」や「底打ち→反転パターン」を検出する手法。

**開発タスク**:
- 要件定義・設計（分析する時系列パターンの定義）
- データ準備（必要なデータマートカラムの追加検討）
- 周期性分析クエリ作成（曜日別・周期別パフォーマンス分析）
- トレンド分析クエリ作成（移動平均・ゴールデンクロス検出）
- リバウンドパターン分析（連続不調後の勝率分析）
- 評価クエリ作成（過去データでの検証）
- ドキュメント作成

**分析要素**:
- **曜日別パフォーマンス**: 各台の曜日別勝率・機械割
- **周期性検出**: 7日・14日・30日周期での高設定パターン
- **移動平均クロス**: 短期MA vs 長期MAのゴールデンクロス
- **連続不調後リバウンド**: N日連続負けの後の勝率
- **ボラティリティ**: 成績の振れ幅（設定変更頻度の推定）

**期待される効果**:
- 店舗の「ローテーション」傾向を捉えられる
- 「連続不調後の調整」パターンを活用できる
- 既存手法では見逃していた時間軸の情報を活用

---

### Phase 3: 台番相関分析 📅 計画中

**ステータス**: 計画中

**概要**:
台同士の成績相関を分析し、「同時に高設定が入りやすいグループ（シマ）」や「翌日に連動するパターン」を検出する手法。

**開発タスク**:
- 要件定義・設計（相関分析の手法選定）
- 同日相関分析（同じ日に好調になりやすい台ペア）
- 翌日相関分析（翌日に連動するパターン）
- グループクラスタリング（相関の高い台のグループ化）
- 評価クエリ作成（過去データでの検証）
- ドキュメント作成

**分析要素**:
- **同日相関**: 同じ日に好調になりやすい台のペア
- **翌日相関**: 台Aが好調の翌日に台Bが好調になる確率
- **グループクラスタリング**: 相関の高い台をグループ化
- **隣接台分析**: 物理的に隣の台との連動
- **末尾番号分析**: 末尾が同じ台の連動

**期待される効果**:
- 設定師の「シマ上げ」「ローテーション」パターンを捉えられる
- 単独の台だけでなく、周囲の状況も考慮できる

---

### Phase 4: 機械学習予測 📅 計画中

**ステータス**: 計画中

**概要**:
過去データで機械学習モデルを訓練し、各台の翌日の「勝率」または「機械割」を直接予測する手法。

**開発タスク**:
- 要件定義・設計（特徴量設計、モデル選定）
- 特徴量エンジニアリング（学習用データセット作成）
- BigQuery MLモデル作成（SQLベースのモデル訓練）
- Python実装（オプション：LightGBM等の高度なモデル）
- 評価・チューニング（ハイパーパラメータ調整）
- ドキュメント作成

**特徴量設計案**:

| カテゴリ | 特徴量 |
|----------|--------|
| 基本統計 | prev_d3_win_rate, prev_d7_win_rate, prev_d28_win_rate |
| 差枚関連 | prev_d28_diff, diff_rank, diff_percentile |
| 時系列 | consecutive_wins, consecutive_losses |
| 曜日 | weekday, is_weekend |
| 特日 | is_special_day, days_since_last_special |
| 台番 | machine_number_last_digit, is_corner |
| 相対位置 | rank_in_island, neighbor_avg_payout |

**期待される効果**:
- 非線形な関係を自動的に学習
- 特徴量重要度から店舗の傾向を解釈可能
- データが増えるほど精度向上

---

### Phase 5: アンサンブル統合 📅 計画中

**ステータス**: 計画中

**前提条件**: Phase 1〜4が完了していること

**概要**:
Phase 1〜4の各手法を統合し、より堅牢な予測を行う手法。

**開発タスク**:
- 統合設計（各手法の重み付け方法検討）
- 統合クエリ作成（各手法のスコアを統合）
- 重み最適化（評価結果に基づく重み調整）
- 評価・検証（過去データでの検証）
- ドキュメント作成

**統合方式案**:

```
最終スコア = α × 戦略マッチングスコア
           + β × 時系列パターンスコア
           + γ × 相関分析スコア
           + δ × ML予測スコア
```

**期待される効果**:
- 単一手法の弱点を補完
- 異なる視点からの「合意」がある台は信頼度が高い
- 各手法の重みを評価結果に基づいて調整可能

---

## 📊 各手法の比較

| 手法 | 実装難易度 | データ要件 | 解釈性 | 既存との補完性 |
|------|-----------|-----------|--------|---------------|
| 戦略マッチング | ★★☆☆☆ | 中（28日以上） | 高い | - |
| 時系列パターン | ★★★☆☆ | 中（30日以上） | 高い | ◎ 補完的 |
| 台番相関 | ★★★☆☆ | 高（60日以上） | 中程度 | ◎ 補完的 |
| 機械学習 | ★★★★☆ | 高（90日以上） | 低い | ○ 代替可能 |
| アンサンブル | ★★★★★ | 高 | 中程度 | ◎ 統合 |

---

## 🎯 成功指標

各フェーズの成功は以下の指標で評価します：

| 指標 | 目標値 | 説明 |
|------|--------|------|
| **勝率** | 55%以上 | TOP1〜TOP3の平均勝率 |
| **機械割** | 103%以上 | TOP1〜TOP3の平均機械割 |
| **既存手法との差** | +2%以上 | 機械割の改善幅 |
| **評価期間** | 60日以上 | 統計的信頼性のための期間 |

---

## 📝 メンテナンス方針

### 定期評価
- 各手法は月1回の定期評価を実施
- 評価結果は `{手法}/results/YYYY-MM-DD/` に保存

### ドキュメント更新
- 手法の変更時は必ずREADMEを更新
- 評価結果はsummary.mdにまとめる

### コードレビュー
- 新規クエリ作成時はテストデータで動作確認
- 既存クエリ変更時は互換性を確認

---

## 🔄 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2026-01-14 | 1.0 | 初版作成 |

---

## 📚 関連ドキュメント

- [全体README](./README.md)
- [戦略マッチング手法](./strategy_matching/README.md)
- [時系列パターン分析](./time_series/README.md)
- [台番相関分析](./correlation/README.md)
- [機械学習予測](./machine_learning/README.md)
- [アンサンブル統合](./ensemble/README.md)
