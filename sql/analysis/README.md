# L+ToLOVEるダークネス 設定投入傾向分析

## 概要

アイランド秋葉原店の「L+ToLOVEるダークネス」について、過去の機械割傾向から高設定に座れる確率を上げるための分析を行います。

## 分析の仮説

1. **短期凹み狙い**: 過去3-7日間が凹んでいる台に高設定が入りやすい
2. **連続高設定狙い**: 過去3-7日間が好調な台は引き続き高設定が入りやすい
3. **長期プラス台狙い**: 28日間でプラス差枚の台は店が推している可能性

### 組み合わせ仮説

| 短期（3-7日） | 長期（28日差枚） | 仮説 |
|---------------|------------------|------|
| 凹み | プラス | 店推し台のリカバリー狙い？ |
| 凹み | マイナス | 低設定放置台？ |
| 好調 | プラス | 継続高設定台？ |
| 好調 | マイナス | 一時的な上振れ？ |

## クエリファイル一覧

### ToLOVEる専用

| ファイル | 用途 |
|----------|------|
| `tolove_detail.sql` | AI分析用の詳細CSV出力 |
| `tolove_summary.sql` | 全期間の集計サマリ |
| `tolove_summary_monthly.sql` | 月別の完全集計 |
| `tolove_scatter.sql` | 散布図用データ |

### 全機種対応（フィルタで絞り込み）

| ファイル | 用途 |
|----------|------|
| `all_machines_detail.sql` | 全機種の詳細データ |
| `all_machines_scatter.sql` | 全機種の散布図用データ |
| `all_machines_summary.sql` | 全機種のカテゴリ別集計 |

### 条件付き確率分析（ベースレートバイアス対策）

| ファイル | 用途 |
|----------|------|
| `tolove_conditional_probability.sql` | 前N日カテゴリ別の「当日104%以上になる確率」|

### 特日戦略シミュレーション

| ファイル | 用途 |
|----------|------|
| `tolove_special_day_simulation.sql` | 特日に最高/最低台を選んだ場合の成績シミュレーション |

## カテゴリ閾値

### 短期機械割（3段階）

| カテゴリ | 条件 | 解釈 |
|----------|------|------|
| 低め | < 102% | 設定2-3相当 |
| 中間 | 102% 〜 105% | 設定4相当 |
| 高め | >= 105% | 設定5-6相当 |

### 長期差枚（2段階）

| カテゴリ | 条件 |
|----------|------|
| プラス | prev_d28_diff >= 0 |
| マイナス | prev_d28_diff < 0 |

---

# 全機種対応版の使い方

## Looker Studio でのフィルタ設定

`all_machines_*.sql` を使う場合、店舗・機種をフィルタで選択できます。

### フィルタの追加手順

1. 「コントロールを追加」→「プルダウンリスト」
2. コントロールフィールド: `hole`（店舗）
3. もう一つ追加: `machine`（機種名）

### レイアウト例

```
┌─────────────────────────────────────────────────────┐
│ 全機種分析ダッシュボード                            │
│ [店舗: アイランド秋葉原店 ▼] [機種: 全て ▼]        │
│ [月: 全期間 ▼]                                      │
├─────────────────────────────────────────────────────┤
│  （グラフ表示エリア）                               │
└─────────────────────────────────────────────────────┘
```

### 使い方

1. 最初は「全て」で全体傾向を確認
2. 気になる機種を選択して詳細分析
3. 複数機種を選択して比較も可能

---

# Looker Studio 可視化ガイド

## Step 1: Looker Studio にアクセス

1. https://lookerstudio.google.com/ を開く
2. Googleアカウントでログイン
3. 「+ 作成」→「レポート」をクリック

## Step 2: BigQuery データソースを追加

1. 「データを追加」画面で「BigQuery」を選択
2. 「カスタムクエリ」を選択
3. プロジェクト: `yobun-450512` を選択
4. 以下のクエリを貼り付け:

```sql
SELECT
  target_date,
  machine_number,
  d1_diff,
  d1_payout_rate,
  prev_d3_payout_rate,
  prev_d5_payout_rate,
  prev_d7_payout_rate,
  prev_d28_diff,
  prev_d28_payout_rate,
  
  CASE
    WHEN prev_d3_payout_rate < 1.02 THEN '1_低め'
    WHEN prev_d3_payout_rate < 1.05 THEN '2_中間'
    ELSE '3_高め'
  END AS prev_d3_category,
  
  CASE
    WHEN prev_d5_payout_rate < 1.02 THEN '1_低め'
    WHEN prev_d5_payout_rate < 1.05 THEN '2_中間'
    ELSE '3_高め'
  END AS prev_d5_category,
  
  CASE
    WHEN prev_d7_payout_rate < 1.02 THEN '1_低め'
    WHEN prev_d7_payout_rate < 1.05 THEN '2_中間'
    ELSE '3_高め'
  END AS prev_d7_category,
  
  CASE
    WHEN prev_d28_diff >= 0 THEN '1_プラス'
    ELSE '2_マイナス'
  END AS prev_d28_diff_category,
  
  FORMAT_DATE('%Y-%m', target_date) AS month

FROM `yobun-450512.datamart.machine_stats`
WHERE hole = 'アイランド秋葉原店'
  AND machine = 'L+ToLOVEるダークネス'
  AND target_date >= DATE('2025-11-03')
  AND prev_d3_payout_rate IS NOT NULL
  AND prev_d28_diff IS NOT NULL
```

5. 「追加」をクリック

---

## Step 3: 推奨する可視化（4つのグラフ）

### グラフ1: 棒グラフ - 短期カテゴリ別の当日機械割

**目的**: 凹み狙い vs 好調狙い どちらが有効か？

| 設定項目 | 値 |
|----------|-----|
| グラフの種類 | 棒グラフ |
| ディメンション | `prev_d3_category` |
| 内訳ディメンション | `prev_d28_diff_category` |
| 指標 | `d1_payout_rate`（平均） |
| 並べ替え | ディメンション昇順 |

**作成手順**:
1. 「グラフを追加」→「棒グラフ」
2. 右側の「データ」パネルで上記を設定
3. 「スタイル」で色を調整（プラス=青、マイナス=赤など）

---

### グラフ2: ピボットテーブル（ヒートマップ風）

**目的**: 短期×長期の組み合わせで最も有利なパターンを発見

| 設定項目 | 値 |
|----------|-----|
| グラフの種類 | ピボットテーブル（ヒートマップ付き） |
| 行のディメンション | `prev_d3_category` |
| 列のディメンション | `prev_d28_diff_category` |
| 指標1 | `d1_payout_rate`（平均） |
| 指標2 | `Record Count`（サンプル数） |

**作成手順**:
1. 「グラフを追加」→「ピボットテーブル（ヒートマップ付き）」
2. 上記を設定
3. 「スタイル」→「ヒートマップ」をON
4. 色: 低=赤、高=緑

**見るべきポイント**:
```
              長期プラス  長期マイナス
短期:低め      [106%]      [99%]     ← 差が大きいほど有意
短期:中間      [103%]      [101%]
短期:高め      [105%]      [102%]
```

---

### グラフ3: 折れ線グラフ - 期間別比較

**目的**: 3日/5日/7日 どの期間が最も予測に有効か？

**簡易版（3つの棒グラフを並べる）**:
- グラフ1のコピーを2つ作成
- それぞれ `prev_d5_category`、`prev_d7_category` に変更
- 横に並べて比較

---

### グラフ4: スコアカード - 全体サマリ

**目的**: 全体の傾向を一目で把握

| 設定項目 | 値 |
|----------|-----|
| グラフの種類 | スコアカード |
| 指標 | `d1_payout_rate`（平均） |

4つ作成して並べる:
1. 全体平均
2. 短期:低め × 長期:プラス のみ（フィルタ設定）
3. 短期:高め × 長期:プラス のみ
4. 短期:低め × 長期:マイナス のみ

---

## Step 4: フィルタの追加

### 期間フィルタ（月別切り替え）

1. 「コントロールを追加」→「プルダウンリスト」
2. コントロールフィールド: `month`
3. これで11月/12月を切り替えて分析可能

### 日付範囲フィルタ

1. 「コントロールを追加」→「期間設定」
2. 期間ディメンション: `target_date`

---

## Step 5: レイアウト例

```
┌─────────────────────────────────────────────────────┐
│ L+ToLOVEるダークネス 設定投入傾向分析               │
│ [月フィルタ: 全期間 ▼] [期間: 2025/11/03-12/22]    │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────────┐  ┌──────────────────────────┐│
│  │ スコアカード     │  │ ピボットテーブル         ││
│  │ 全体平均: 102.5% │  │ (ヒートマップ)           ││
│  │                  │  │                          ││
│  │ 最有力: 106.2%   │  │       プラス  マイナス   ││
│  │ (低め×プラス)   │  │ 低め  [106%]  [99%]     ││
│  └──────────────────┘  │ 中間  [103%]  [101%]    ││
│                        │ 高め  [105%]  [102%]    ││
│                        └──────────────────────────┘│
│                                                     │
│  ┌────────────────────────────────────────────────┐│
│  │ 棒グラフ: 短期カテゴリ別 × 長期カテゴリ        ││
│  │                                                ││
│  │  ■ 長期プラス  ■ 長期マイナス                 ││
│  │                                                ││
│  │  106%                                          ││
│  │  104%  ████                                   ││
│  │  102%  ████  ████  ████                      ││
│  │  100%  ████  ████  ████                      ││
│  │        低め   中間   高め                      ││
│  └────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
```

---

## 散布図: 過去N日差枚 vs 当日差枚

### 目的

過去N日間の差枚と当日差枚の相関関係を視覚化し、「凹んでいる台は当日勝ちやすいか？」を確認する。

### データソースクエリ

`tolove_scatter.sql` を使用、または以下をLooker Studioのカスタムクエリに貼り付け:

```sql
SELECT
  target_date,
  machine_number,
  d1_diff,
  d1_payout_rate,
  prev_d3_diff,
  prev_d5_diff,
  prev_d7_diff,
  prev_d28_diff,
  prev_d3_payout_rate,
  prev_d5_payout_rate,
  prev_d7_payout_rate,
  prev_d28_payout_rate,
  CASE
    WHEN prev_d28_diff >= 0 THEN 'プラス'
    ELSE 'マイナス'
  END AS prev_d28_category,
  FORMAT_DATE('%Y-%m', target_date) AS month
FROM `yobun-450512.datamart.machine_stats`
WHERE hole = 'アイランド秋葉原店'
  AND machine = 'L+ToLOVEるダークネス'
  AND target_date >= DATE('2025-11-03')
  AND prev_d3_diff IS NOT NULL
  AND prev_d28_diff IS NOT NULL
```

### Looker Studio での散布図作成手順

#### 散布図1: 過去3日差枚 vs 当日差枚

1. 「グラフを追加」→「散布図」を選択
2. 以下を設定:

| 設定項目 | 値 |
|----------|-----|
| X軸の指標 | `prev_d3_diff` |
| Y軸の指標 | `d1_diff` |
| ディメンション | `target_date` または `machine_number` |
| 内訳ディメンション（色分け） | `prev_d28_category`（長期プラス/マイナス） |

3. 「スタイル」タブで調整:
   - ポイントサイズ: 8〜10
   - 色: プラス=青、マイナス=赤
   - トレンドライン: ON（相関を確認）

#### 散布図2〜4: 過去5日/7日/28日

- 散布図1をコピーして3つ作成
- X軸の指標をそれぞれ変更:
  - `prev_d5_diff`
  - `prev_d7_diff`
  - `prev_d28_diff`

### レイアウト例（4つの散布図）

```
┌─────────────────────────────────────────────────────┐
│ 散布図: 過去N日差枚 vs 当日差枚                     │
│ [月フィルタ: 全期間 ▼]                              │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────────────┐  ┌──────────────────────────┐│
│  │ 過去3日 vs 当日  │  │ 過去5日 vs 当日          ││
│  │       ●          │  │          ●               ││
│  │    ●    ●        │  │       ●    ●             ││
│  │  ●  ●     ●      │  │    ●  ●     ●            ││
│  │●     ●      ●    │  │ ●     ●      ●           ││
│  └──────────────────┘  └──────────────────────────┘│
│                                                     │
│  ┌──────────────────┐  ┌──────────────────────────┐│
│  │ 過去7日 vs 当日  │  │ 過去28日 vs 当日         ││
│  │       ●          │  │          ●               ││
│  │    ●    ●        │  │       ●    ●             ││
│  │  ●  ●     ●      │  │    ●  ●     ●            ││
│  │●     ●      ●    │  │ ●     ●      ●           ││
│  └──────────────────┘  └──────────────────────────┘│
└─────────────────────────────────────────────────────┘

■ 長期プラス（青）  ■ 長期マイナス（赤）
```

### 散布図の見方

| パターン | 意味 |
|----------|------|
| 右肩上がり | 過去好調 → 当日も好調（正の相関） |
| 右肩下がり | 過去好調 → 当日は凹む（負の相関）★狙い目かも |
| ランダム | 相関なし（過去のデータは参考にならない） |

### 注目ポイント

1. **トレンドラインの傾き**
   - 負の傾き → 凹み狙いが有効
   - 正の傾き → 好調台継続狙いが有効
   - 水平 → 相関なし

2. **色（長期カテゴリ）別の分布**
   - 青（長期プラス）の点が上部に集中 → 長期プラス台を狙うべき
   - 赤（長期マイナス）の点が下部に集中 → 長期マイナス台は避けるべき

3. **どの期間の相関が強いか**
   - 4つの散布図を比較し、最もトレンドラインが急なものが予測に有効

---

## 分析の見方まとめ

| 見るべきポイント | 判断基準 |
|------------------|----------|
| 短期カテゴリの差 | 「低め」と「高め」で3%以上差があれば有意 |
| 長期カテゴリの影響 | プラス台とマイナス台で傾向が違うか |
| サンプル数 | 10件未満は信頼性低い |
| 月別の違い | 11月と12月で傾向が変わっていないか |

### 結論の出し方

```
ピボットテーブルで最も機械割が高いセル = 狙うべき条件

例: 「短期:低め × 長期:プラス」が106%で最高
    → 28日間でプラスだが直近3日凹んでいる台を狙う！
```

---

## AIに分析を依頼する場合のプロンプト例

```
以下はパチスロ「L+ToLOVEるダークネス」の台別データです。
アイランド秋葉原店の2025年11月〜12月のデータです。

【分析依頼】
1. 過去の機械割が低い台（凹み台）と高い台（好調台）で、
   当日の機械割に傾向の違いはありますか？

2. 長期（28日間）の差枚がプラスの台とマイナスの台で、
   当日の機械割に傾向の違いはありますか？

3. 短期の凹み/好調と長期の差枚を組み合わせた場合、
   どの組み合わせが最も当日機械割が高い傾向にありますか？

4. 台選びの戦略として、どのような条件の台を狙うべきか
   提案してください。

【補足情報】
- この機種の設定別機械割: 設定2=98%, 3=99%, 4=102.5%, 5=105.8%, 6=110.1%
- 換金ギャップを考慮すると機械割104%以上（設定5以上）が必要
- 荒い機種のため1日の結果はブレが大きい
- この店舗は設定4以上を頻繁に使用している傾向がある

【データ説明】
- target_date: 集計日
- machine_number: 台番
- prev_d3_payout_rate: 前日から3日間の機械割（当日を含まない）
- prev_d28_diff: 前日から28日間の差枚（当日を含まない）
- d1_payout_rate: 当日の機械割
- d1_diff: 当日の差枚
- prev_d3_category: 短期3日間のカテゴリ（低め/中間/高め）
- prev_d28_diff_category: 長期28日間の差枚カテゴリ（プラス/マイナス）

【CSVデータ】
（ここにCSVを貼り付け）
```

