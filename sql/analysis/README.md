# L+ToLOVEるダークネス 分析システム ドキュメント

## 概要

アイランド秋葉原店の「L+ToLOVEるダークネス」について、過去の機械割傾向から高設定に座れる確率を上げるための分析システムです。

本システムは以下の3つのコンポーネントで構成されています：

1. **`datamart_machine_stats.sql`**: 生データから台番別統計データを生成するデータマート
2. **`tolove_recommendation.sql`**: 戦略シミュレーションと台番推薦を行う分析クエリ
3. **`tolove_recommendation.gs`**: 推奨台をスコアリングしてランキングするGoogle Apps Script

---

## 1. データマート: `datamart_machine_stats.sql`

### 1.1 概要

生データテーブル（`yobun-450512.slot_data.data_*`）から、台番別の統計データを集計し、データマートテーブル（`yobun-450512.datamart.machine_stats`）に保存します。

### 1.2 実行方法

#### スケジュールクエリでの実行（推奨）

1. BigQueryコンソールで「スケジュールクエリ」を作成
2. クエリに `datamart_machine_stats.sql` の内容を貼り付け
3. パラメータ `@run_time` を設定（TIMESTAMP型、実行時刻が自動設定される）
4. 宛先テーブル: `yobun-450512.datamart.machine_stats`
5. 書き込み設定: 「テーブルに追加」または「上書き」

#### 手動実行

スケジュールクエリを使用しない場合、`@run_time` パラメータを手動で設定する必要があります：

```sql
SET @run_time = CURRENT_TIMESTAMP();
-- その後、datamart_machine_stats.sql の内容を実行
```

### 1.3 集計日（target_date）の決定

- **集計日 = 実行日の1日前（JST基準）**
- `DATE(@run_time, 'Asia/Tokyo') - 1` で計算
- 例: 12/25 00:00（JST）に実行 → 集計日は 12/24

### 1.4 集計期間の種類

#### 当日を含む期間（d*）

- **d1**: 当日のみ
- **d3**: 当日から3日間（当日を含む）
- **d5**: 当日から5日間（当日を含む）
- **d7**: 当日から7日間（当日を含む）
- **d28**: 当日から28日間（当日を含む）
- **mtd**: 当月1日から当日まで

#### 当日を含まない期間（prev_d*）

- **prev_d1**: 前日のみ
- **prev_d3**: 前日から3日間（当日を含まない）
- **prev_d5**: 前日から5日間（当日を含まない）
- **prev_d7**: 前日から7日間（当日を含まない）
- **prev_d28**: 前日から28日間（当日を含まない）
- **prev_mtd**: 当月1日から前日まで

### 1.5 集計項目

各期間について以下の項目を集計：

- **差枚（diff）**: 合計差枚
- **ゲーム数（game）**: 合計ゲーム数
- **勝率（win_rate）**: 勝利日数 / 総日数
- **機械割（payout_rate）**: `(ゲーム数 × 3 + 差枚) / (ゲーム数 × 3)`

### 1.6 データの重複排除

同じ日付・店舗・台番のデータが複数存在する場合、`timestamp` が最新のものを採用します。

### 1.7 台番マッピング（アイランド秋葉原店）

2025/11/02以前と2025/11/03以降で台番が変更されたため、過去データの台番を新しい台番にマッピングします。

- マッピング定義は `machine_number_mapping` CTE内に記載
- 2025/11/02以前のデータのみマッピングを適用

### 1.8 機種変更の検出

各台番について、現在の機種名で集計を開始した日（`start_date`）を算出します。これにより、機種変更前のデータを除外できます。

### 1.9 テーブル構造

```sql
CREATE TABLE `yobun-450512.datamart.machine_stats` (
  target_date DATE,              -- 集計日（パーティションキー）
  hole STRING,                   -- 店舗名
  machine_number INT64,         -- 台番
  machine STRING,                -- 機種名
  start_date DATE,              -- 集計開始日（機種変更検出用）
  end_date DATE,                -- 集計終了日
  
  -- 当日データ
  d1_diff INT64,
  d1_game INT64,
  d1_payout_rate FLOAT64,
  
  -- 当日を含む期間
  d3_diff INT64, d3_game INT64, d3_win_rate FLOAT64, d3_payout_rate FLOAT64,
  d5_diff INT64, d5_game INT64, d5_win_rate FLOAT64, d5_payout_rate FLOAT64,
  d7_diff INT64, d7_game INT64, d7_win_rate FLOAT64, d7_payout_rate FLOAT64,
  d28_diff INT64, d28_game INT64, d28_win_rate FLOAT64, d28_payout_rate FLOAT64,
  mtd_diff INT64, mtd_game INT64, mtd_win_rate FLOAT64, mtd_payout_rate FLOAT64,
  
  -- 当日を含まない期間
  prev_d1_diff INT64, prev_d1_game INT64, prev_d1_payout_rate FLOAT64,
  prev_d2_diff INT64, prev_d2_game INT64, prev_d2_win_rate FLOAT64, prev_d2_payout_rate FLOAT64,
  prev_d3_diff INT64, prev_d3_game INT64, prev_d3_win_rate FLOAT64, prev_d3_payout_rate FLOAT64,
  prev_d5_diff INT64, prev_d5_game INT64, prev_d5_win_rate FLOAT64, prev_d5_payout_rate FLOAT64,
  prev_d7_diff INT64, prev_d7_game INT64, prev_d7_win_rate FLOAT64, prev_d7_payout_rate FLOAT64,
  prev_d28_diff INT64, prev_d28_game INT64, prev_d28_win_rate FLOAT64, prev_d28_payout_rate FLOAT64,
  prev_mtd_diff INT64, prev_mtd_game INT64, prev_mtd_win_rate FLOAT64, prev_mtd_payout_rate FLOAT64
)
PARTITION BY target_date;
```

### 1.10 MERGE文による更新

- 同じ日付のデータが既に存在する場合: **上書き**
- 異なる日付のデータ: **追加**

これにより、同じ日付でクエリを再実行しても、最新のデータで上書きされます。

---

## 2. 戦略シミュレーション + 台番推薦: `tolove_recommendation.sql`

### 2.1 概要

過去データに基づく様々な台選び戦略の有効性をシミュレーションし、さらに次の日に打つべき台番を推薦します。

### 2.2 パラメータ設定

クエリ冒頭の `DECLARE` 文で以下を設定できます：

```sql
DECLARE target_date DATE DEFAULT NULL;  -- 推奨台を出す日付（NULL=最新日の次の日）
DECLARE target_hole STRING DEFAULT 'アイランド秋葉原店';  -- 対象店舗
DECLARE target_machine STRING DEFAULT 'L+ToLOVEるダークネス';  -- 対象機種
```

### 2.3 クエリの構造

#### Part 0: パラメータ・設定定義
- 推奨台を出す日付の決定

#### Part 1: 基本データ・マスタ定義
- 基本データの取得（`datamart.machine_stats` から）
- 特日定義（0のつく日、1のつく日、6のつく日、月最終日）
- 曜日カテゴリ定義（全日、平日、土日祝、特日）
- 長期条件マスタ（過去28日間の条件）
- 短期条件マスタ（過去3/5/7日間の条件、末尾関連性）
- 戦略組み合わせの自動生成

#### Part 2: シミュレーション（過去検証）
- 基本戦略の適用（差枚ランキング、勝率条件）
- 複合戦略の適用（長期×短期の組み合わせ）
- 曜日カテゴリ別の集計

#### Part 3: 次の日の台番算出
- 最新日のデータ取得
- 次の日の情報（日付、土日祝フラグ、特日フラグ、末尾情報）
- 基本戦略の該当台番
- 複合戦略の該当台番

#### Part 4: 最終出力
- シミュレーション結果と台番推薦を結合

### 2.4 戦略の種類

#### 基本戦略（単一期間参照）

1. **差枚ベース（4種類）**
   - 差枚ベスト1~5: 差枚1~5位の台を選ぶ
   - 差枚ベスト6~10: 差枚6~10位の台を選ぶ
   - 差枚ワースト1~5: 差枚下位1~5位の台を選ぶ
   - 差枚ワースト6~10: 差枚下位6~10位の台を選ぶ

2. **勝率ベース（6段階、MECE）**
   - 勝率100%: 全勝台を選ぶ
   - 勝率75%超100%未満: 勝率75%超100%未満の台を選ぶ
   - 勝率50%超75%以下: 勝率50%超75%以下の台を選ぶ
   - 勝率25%超50%以下: 勝率25%超50%以下の台を選ぶ
   - 勝率0%超25%未満: 勝率0%超25%未満の台を選ぶ
   - 勝率0%: 全敗台を選ぶ

#### 複合戦略（長期×短期の組み合わせ）

**長期条件（13種類）**:
- 条件なし: 1種類
- 過去28日間勝率（4種類、MECE、パーセンタイルベース）:
  - 50.0%以上（上位25%、p75以上）
  - 42.9%以上50.0%未満（上位25%〜50%、p50〜p75）
  - 35.7%以上42.9%未満（下位25%〜50%、p25〜p50）
  - 35.7%未満（下位25%、p25未満）
- 過去28日間機械割（4種類、MECE、パーセンタイルベース）:
  - 104.47%以上（上位25%、p75以上）
  - 102.47%以上104.47%未満（上位25%〜50%、p50〜p75）
  - 100.91%以上102.47%未満（下位25%〜50%、p25〜p50）
  - 100.91%未満（下位25%、p25未満）
- 過去28日間差枚（4種類、ランキングベース）:
  - ベスト1~5、ベスト6~10
  - ワースト1~5、ワースト6~10

**短期条件（23種類）**:
- 条件なし: 1種類
- 勝率条件（18種類、MECE、6段階）:
  - 過去3/5/7日間 × 6段階（100%、75%超100%未満、50%超75%以下、25%超50%以下、0%超25%未満、0%）
  - 注: 短期は離散的で現在の区切りが適切なため、6段階を維持
- 末尾関連性（4種類）:
  - 台番末尾1桁=日付末尾1桁
  - 台番末尾2桁=日付末尾2桁
  - 台番末尾1桁=日付末尾1桁+1
  - 台番末尾1桁=日付末尾1桁-1

**組み合わせ数**: 13 × 23 = 299種類

**長期条件と短期条件の評価ロジックの統一**:
- 長期条件の勝率評価を短期条件と同じロジック（threshold_upperを使用）に統一
- これにより、コードの重複を削減し、保守性が向上
- 期間別勝率値の計算をCTE（compound_evaluation_base、next_compound_evaluation_base）で行い、評価ロジックを簡潔化

### 2.5 MECE化の理由

条件が重複すると、同じ台が複数の戦略に重複してカウントされ、評価が不当に高くなります。範囲を細かく分割することで、各条件が独立し、正確な評価が可能になります。

### 2.6 勝率範囲の定義

#### 短期条件（MECE、6段階）

短期条件（過去3/5/7日間）は離散的で現在の区切りが適切なため、6段階を維持しています：

- **100%**: 全勝（`>= 1.0 AND <= 1.0`）
- **75%超100%未満**: ほとんど勝ち（`> 0.75 AND < 1.0`）
- **50%超75%以下**: 中間やや勝ち（`> 0.5 AND <= 0.75`）
- **25%超50%以下**: 中間やや負け（`> 0.25 AND <= 0.5`）
- **0%超25%未満**: ほとんど負け（`> 0.0 AND < 0.25`）
- **0%**: 全敗（`>= 0.0 AND <= 0.0`）

#### 長期条件（MECE、4種類、パーセンタイルベース）

長期条件（過去28日間）は実際のデータ分布に基づくパーセンタイルベースで設定しています：

- **50.0%以上**: 上位25%（p75以上、`>= 0.50`）
- **42.9%以上50.0%未満**: 上位25%〜50%（p50〜p75、`>= 0.429 AND < 0.50`）
- **35.7%以上42.9%未満**: 下位25%〜50%（p25〜p50、`>= 0.357 AND < 0.429`）
- **35.7%未満**: 下位25%（p25未満、`< 0.357`）

### 2.7 データ参照の違い

- **シミュレーション（過去検証）**: `prev_d*` カラム（当日を含まない過去データ）を使用
- **次の日の台番算出**: `d*` カラム（最新日を含む過去データ）を使用

### 2.8 曜日カテゴリと台番出力の関係

- **全日**: 常に出力
- **平日**: 次の日が平日の場合のみ出力
- **土日祝**: 次の日が土日祝の場合のみ出力
- **特日**: 次の日が特日の場合のみ出力

### 2.9 出力項目

#### シミュレーション結果

| 項目 | 説明 |
|------|------|
| 曜日 | 全日、平日、土日祝、特日 |
| 参照期間 | 前日、過去3日、過去5日、過去7日、過去28日、複合 |
| 戦略 | 戦略名 |
| 実施日数 | その戦略が適用された日数 |
| 参照台数 | その戦略で選ばれた台の総数 |
| 勝利日数 | その戦略で選んだ台が勝った日数 |
| 勝率 | 勝利日数 / 参照台数 × 100 |
| 合計差枚 | その戦略で選んだ台の差枚の合計 |
| 平均差枚 | 合計差枚 / 参照台数 |
| 機械割 | (ゲーム数 × 3 + 差枚) / (ゲーム数 × 3) × 100 |

#### 台番推薦

| 項目 | 説明 |
|------|------|
| 次の日 | 推奨台を出す日付 |
| 該当台番 | その戦略で選ばれる台番（カンマ区切り） |

### 2.10 特日定義の編集方法

店舗によって特日の定義が異なる場合は、以下の2箇所を編集してください：

1. **`special_day_logic` CTE（Part 1-2）**: シミュレーション用の特日判定
2. **`next_day_info` CTE（Part 3-2）**: 次の日の特日判定

現在の定義（アイランド秋葉原店用）:
- 0のつく日（10, 20, 30）
- 1のつく日（1, 11, 21, 31）
- 6のつく日（6, 16, 26）
- 月最終日

---

## 3. 推奨台のスコアリング: `tolove_recommendation.gs`

### 3.1 概要

BigQueryの実行結果（`tolove_recommendation.sql`）をスプレッドシートの「狙い台抽出」シートに接続し、`tolove_recommendation.gs` を実行すると「狙い台一覧」シートが生成されます。

### 3.2 使い方

1. BigQueryで `tolove_recommendation.sql` を実行
2. 結果をスプレッドシートの「狙い台抽出」シートにエクスポート（またはBigQuery Connectorで接続）
3. スプレッドシートのメニューから「狙い台」→「狙い台一覧を更新」を実行
4. 「狙い台一覧」シートに結果が出力される

### 3.3 入力データの形式

「狙い台抽出」シートには以下の列が必要です：

| 列名 | 説明 | 必須 |
|------|------|------|
| 次の日 | 推奨台を出す日付 | ✓ |
| 該当台番 | カンマ区切りの台番（例: "1227, 1268"） | ✓ |
| 勝率 | %表記の数値（例: 63.6） | ✓ |
| 機械割 | %表記の数値（例: 122.71） | ✓ |
| 参照台数 | その戦略で選ばれた台の総数 | - |
| 実施日数 | その戦略が適用された日数 | - |

### 3.4 スコアリング方法

各台番に対して以下のスコアを計算し、総合スコアでランキングします。

#### 1. 重み付け平均機械割・勝率

参照台数で重み付けした平均値を計算します。

**計算式**:
```
重み付け平均機械割 = Σ(機械割 × 参照台数) / Σ(参照台数)
重み付け平均勝率 = Σ(勝率 × 参照台数) / Σ(参照台数)
```

**例**:
- 台番1227が以下の3つの戦略で推奨されている場合
  - 戦略A: 機械割122.71%, 勝率63.6%, 参照台数10台
  - 戦略B: 機械割115.50%, 勝率50.0%, 参照台数50台
  - 戦略C: 機械割110.00%, 勝率40.0%, 参照台数5台

```
重み付け平均機械割 = (122.71×10 + 115.50×50 + 110.00×5) / (10+50+5)
                    = 7552.1 / 65
                    = 116.19% → 1.1619（0-1の範囲に変換）
```

#### 2. RMS（Root Mean Square: 二乗平均平方根）

機械割と勝率のバランスを評価します。

**計算式**:
```
RMS = sqrt((重み付け平均機械割^2 + 重み付け平均勝率^2) / 2)
```

**例**:
```
RMS = sqrt((1.1619^2 + 0.5132^2) / 2)
    = sqrt((1.3500 + 0.2634) / 2)
    = sqrt(0.8067)
    = 0.8982
```

#### 3. 信頼性スコア

実施日数と参照台数の合計が多いほど、その戦略の結果は信頼性が高いと評価します。

**計算式**:
```
信頼性スコア = (実施日数 + 参照台数) / 最大値
```

**例**:
- 台番1227の合計が100、最大値が500の場合
```
信頼性スコア = 100 / 500 = 0.20
```

#### 4. 出現頻度ボーナス

複数の戦略で推奨されている台ほど高得点になります。

**計算式**:
```
出現頻度ボーナス = sqrt(該当数) / sqrt(最大該当数)
```

**例**:
- 台番1227の該当数が4回、最大値が16回の場合
```
出現頻度ボーナス = sqrt(4) / sqrt(16) = 2 / 4 = 0.50
```

平方根を使うことで、出現数が多いほどボーナスが増えますが、増加率は減ります（例: 1回→4回は2倍、4回→9回は1.5倍）。

#### 5. 総合スコア

上記の3つの指標を組み合わせます。

**計算式**:
```
総合スコア = RMS × 信頼性スコア × 出現頻度ボーナス
```

**例**:
```
総合スコア = 0.8982 × 0.90 × 0.75 = 0.6063
```

### 3.5 出力項目

「狙い台一覧」シートには以下の列が出力されます：

| 列名 | 説明 | フォーマット |
|------|------|--------------|
| 日付 | 次の日 | yyyy-mm-dd |
| 台番 | 該当台番 | 文字列 |
| 総合スコア | RMS × 信頼性スコア × 出現頻度ボーナス | 0.000（小数3桁） |
| 該当数 | 出現回数 | 0（整数） |
| 重み付け平均機械割 | 参照台数で重み付けした機械割の平均 | 0.000（小数3桁） |
| 重み付け平均勝率 | 参照台数で重み付けした勝率の平均 | 0.000（小数3桁） |
| 信頼性スコア | 実施日数と参照台数の合計を正規化 | 0.000（小数3桁） |
| 出現頻度ボーナス | 該当数の平方根を正規化 | 0.000（小数3桁） |

### 3.6 ソート順

1. 日付昇順
2. 総合スコア降順
3. 台番昇順

### 3.7 信頼できる狙い台の基準（目安）

実際のデータ分布を確認して、適切な基準を設定してください。理論的な目安は以下の通りです：

- **0.300以上**: 高信頼性（優先的に検討）
- **0.200-0.300**: 信頼できる（検討候補）
- **0.100-0.200**: やや信頼できる（参考程度）
- **0.100未満**: 信頼性が低い（慎重に判断）

---

## 4. クエリファイル一覧

### 分析クエリ

| ファイル | 用途 |
|----------|------|
| `tolove_special_day_simulation_jp.sql` | 特日に最高/最低台を選んだ場合の成績シミュレーション |
| `tolove_recommendation.sql` | 戦略シミュレーション + 次の日に打つべき台番の推薦 |

### データマート

| ファイル | 用途 |
|----------|------|
| `datamart_machine_stats.sql` | 生データから台番別統計データを生成 |

### Google Apps Script

| ファイル | 用途 |
|----------|------|
| `tolove_recommendation.gs` | BigQueryの推奨台結果をスプレッドシートの「狙い台一覧」シートに集計・スコアリング |

---

## 5. ワークフロー

### 5.1 日常的な運用フロー

1. **データマートの更新**（毎日自動実行）
   - `datamart_machine_stats.sql` をスケジュールクエリで実行
   - 前日のデータが `datamart.machine_stats` に追加/更新される

2. **戦略シミュレーションと台番推薦**（手動実行）
   - `tolove_recommendation.sql` をBigQueryで実行
   - 結果をスプレッドシートの「狙い台抽出」シートにエクスポート

3. **スコアリング**（手動実行）
   - スプレッドシートのメニューから「狙い台」→「狙い台一覧を更新」を実行
   - 「狙い台一覧」シートに結果が出力される

4. **台選び**
   - 「狙い台一覧」シートの総合スコアを参考に、狙う台を決定

### 5.2 パラメータの調整

`tolove_recommendation.sql` のパラメータを調整することで、以下のことが可能です：

- **特定の日付の推奨台を取得**: `DECLARE target_date DATE DEFAULT '2026-01-15';`
- **別の店舗・機種を分析**: `DECLARE target_hole` と `DECLARE target_machine` を変更

---

## 6. 注意事項

### 6.1 データの整合性

- `datamart_machine_stats.sql` は毎日実行することを推奨します
- 同じ日付で再実行すると、既存データが上書きされます

### 6.2 特日定義の編集

店舗によって特日の定義が異なる場合は、`tolove_recommendation.sql` の以下の2箇所を編集してください：

1. `special_day_logic` CTE（Part 1-2）
2. `next_day_info` CTE（Part 3-2）

### 6.3 スコアリングの調整

`tolove_recommendation.gs` のスコアリング方法を変更したい場合は、以下の関数を編集してください：

- `buildNeraiDaiIchiran()`: メイン処理
- スコア計算部分（RMS、信頼性スコア、出現頻度ボーナス、総合スコア）

---

## 7. トラブルシューティング

### 7.1 データマートが更新されない

- スケジュールクエリの設定を確認
- `@run_time` パラメータが正しく設定されているか確認
- エラーログを確認

### 7.2 推奨台が出力されない

- `datamart.machine_stats` に最新のデータが存在するか確認
- `tolove_recommendation.sql` のパラメータ（`target_hole`, `target_machine`）を確認
- 該当する戦略が存在するか確認

### 7.3 スコアリングが実行されない

- 「狙い台抽出」シートに必要な列が存在するか確認
- 列名が正しいか確認（「次の日」「該当台番」「勝率」「機械割」など）
- GASのエラーログを確認
