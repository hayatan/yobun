# 戦略マッチング手法

## 📋 概要

事前定義した戦略条件（勝率・機械割・差枚ランキングの組み合わせ）に対する過去パフォーマンスを計算し、各台が該当する戦略のスコアをRMS（二乗平均平方根）で統合する手法です。

**ステータス**: ✅ 完了（運用中）

---

## 📂 ファイル構成

```
strategy_matching/
├── README.md                           # このファイル
├── recommendation_output.sql           # 狙い台一覧出力クエリ
├── recommendation_output_説明文.md     # スプレッドシート向け説明
├── recommendation_evaluation.sql       # 評価クエリ
├── scripts/
│   └── analyze_batch_results.py        # バッチ評価結果分析スクリプト
└── results/
    ├── README.md                       # 結果ディレクトリの説明
    └── YYYY-MM-DD/                     # 評価実行日ごとの結果
        ├── evaluation_results.md       # 詳細レポート
        └── summary.md                  # サマリー
```

---

## 🔧 手法の詳細

### 戦略条件

#### 長期条件（過去28日間ベース）

| カテゴリ | 条件 | 閾値 |
|----------|------|------|
| 勝率 | 高勝率 | 50%以上 |
| 勝率 | 中高勝率 | 42.9%以上50%未満 |
| 勝率 | 中低勝率 | 35.7%以上42.9%未満 |
| 勝率 | 低勝率 | 35.7%未満 |
| 機械割 | 高機械割 | 104.47%以上 |
| 機械割 | 中高機械割 | 102.47%以上 |
| 機械割 | 中低機械割 | 100.91%以上 |
| 機械割 | 低機械割 | 100.91%未満 |
| 差枚ランキング | ベスト1-5 | - |
| 差枚ランキング | ベスト6-10 | - |
| 差枚ランキング | ワースト1-5 | - |
| 差枚ランキング | ワースト6-10 | - |

#### 短期条件

| カテゴリ | 条件 | 説明 |
|----------|------|------|
| 直近勝率 | 3/5/7日間 | 100% / 75%超 / 50%超75%以下 / 25%超50%以下 / 0%超25%未満 / 0% |
| 台番末尾 | 日付末尾一致 | 1桁一致 / 2桁一致 / +1 / -1 |
| 特日 | 店舗ごと定義 | 特日 / 特日以外 |

### スコア計算

```
総合スコア = RMS × 頻度ボーナス × 複合ボーナス × 信頼性スコア × 異常値ボーナス
```

| 要素 | 説明 |
|------|------|
| **RMS** | 勝率パーセンタイルと機械割パーセンタイルの二乗平均平方根 |
| **頻度ボーナス** | `sqrt(該当数) / sqrt(最大該当数)` |
| **複合ボーナス** | 機械割・勝率両方がp50以上で1.1 |
| **信頼性スコア** | days≥30かつref_count≥50で1.0 |
| **異常値ボーナス** | 機械割がp75の1.05倍以上で1.1 |

### スコア計算メソッド

| メソッド | 計算式 | 用途 |
|----------|--------|------|
| `original` | RMS × 信頼性 × 頻度 × 異常値 × 複合 | 全要素考慮（推奨） |
| `simple` | RMSのみ | シンプルな比較 |
| `rms_reliability` | RMS × 信頼性 | データ量差がある場合 |
| `rms_frequency` | RMS × 頻度ボーナス | 複数戦略該当重視 |
| `rms_frequency_dual` | RMS × 頻度 × 複合 | バランス型 |
| `rms_frequency_anomaly` | RMS × 頻度 × 異常値 | 高出玉台重視 |
| `rms_frequency_filter` | RMS × 頻度（有効性0.5以上のみ） | ノイズ除去 |

---

## 📊 優先度ランク

TOP1スコア（各店舗・機種・メソッド内での最高スコア）との比率に基づくランク：

| ランク | 条件 | 意味 | 推奨度 |
|--------|------|------|--------|
| **5** | TOP1の99%以上 | 最優先 | ⭐⭐⭐⭐⭐ |
| **4** | TOP1の97%以上 | 高優先 | ⭐⭐⭐⭐ |
| **3** | TOP1の95%以上 | 優先 | ⭐⭐⭐ |
| **2** | TOP1の90%以上 | やや優先 | ⭐⭐ |
| **1** | TOP1の80%以上 | 参考 | ⭐ |
| **0** | それ以外 | 対象外 | - |

---

## 🚀 使い方

### 1. 狙い台一覧の取得

BigQuery Connectorで `recommendation_output.sql` を実行：

```sql
-- params CTE 内のパラメータを編集
params AS (
  SELECT * FROM UNNEST([
    STRUCT(CAST(NULL AS DATE) AS target_date, 
           'アイランド秋葉原店' AS target_hole, 
           'L+ToLOVEるダークネス' AS target_machine, 
           'island' AS special_day_type, 
           'original' AS score_method),
    -- 他の機種を追加...
  ])
),
```

### 2. 評価の実行

BigQueryで `recommendation_evaluation.sql` を実行し、CSVエクスポート後に分析：

```bash
python scripts/analyze_batch_results.py /path/to/exported.csv > results/$(date +%Y-%m-%d)/evaluation_results.md
```

### 3. パラメータ調整

評価結果に基づき、各機種の最適なメソッドを選択：

| 店舗 | 機種 | 推奨メソッド |
|------|------|-------------|
| アイランド | L+ToLOVEるダークネス | `original` |
| エスパス | Lソードアート・オンライン | `rms_frequency` |
| エスパス | マギアレコード | `rms_frequency` |

---

## 📈 評価結果サマリー

最新の評価結果: `results/2026-01-14/summary.md`

### 積極的に狙うべき機種

| 店舗 | 機種 | 推奨メソッド | 信頼度 | 狙い定めの効果 |
|------|------|-------------|--------|---------------|
| アイランド | L+ToLOVEるダークネス | `original` | ⭐⭐⭐⭐⭐ | ◎ 極めて有効 |
| エスパス | Lソードアート・オンライン | `rms_frequency` | ⭐⭐⭐⭐ | ○ 有効 |
| エスパス | マギアレコード | `rms_frequency` | ⭐⭐⭐⭐ | ○ 有効 |

---

## 💡 特徴と制限

### 強み

- **解釈性が高い**: どの戦略が効いているか分かりやすい
- **カスタマイズ可能**: 戦略条件を店舗・機種に合わせて調整可能
- **SQLで完結**: BigQuery Connectorで直接使用可能

### 制限

- **条件の組み合わせ爆発**: 戦略数が多くなると計算量が増加
- **時間的パターンを捉えにくい**: 周期性や曜日傾向は考慮していない
- **台同士の関係性を無視**: シマ単位のパターンは考慮していない

---

## 🔄 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2026-01-14 | ディレクトリ構造整理、READMEを独立化 |
| 2026-01-13 | 複数店舗・機種対応版に拡張 |
| 2025-12-XX | 初版作成 |

---

## 📚 関連ドキュメント

- [全体README](../README.md)
- [開発ロードマップ](../ROADMAP.md)
- [スプレッドシート向け説明](./recommendation_output_説明文.md)
- [評価結果](./results/README.md)
