# machine_stats データマート

台番別統計データを集計するデータマートです。BigQueryスケジュールクエリで毎日自動実行されます。

## ファイル一覧

| ファイル | 用途 |
|----------|------|
| `create_table.sql` | テーブル作成DDL |
| `query.sql` | データマート生成クエリ（スケジュールクエリ用） |

## 使用方法

### 1. テーブル作成（初回のみ）

BigQueryコンソールで `create_table.sql` を実行します。

```sql
-- テーブル構造を変更する場合は、既存テーブルを削除してから再作成
DROP TABLE IF EXISTS `yobun-450512.datamart.machine_stats`;
```

### 2. スケジュールクエリ設定

BigQueryコンソールでスケジュールクエリを設定します：

- **クエリ**: `query.sql` の内容
- **宛先テーブル**: `yobun-450512.datamart.machine_stats`
- **スケジュール**: 毎日（例: 09:00 JST）
- **パラメータ**: `@run_time` を使用（実行時刻が自動的に渡される）

### 3. バックフィル実行

過去データを再生成する場合は、BigQueryコンソールで `@run_time` を指定して手動実行します。

## 日付関連カラム

集計日（target_date）に関する情報を事前計算したカラムです。特日判定などに利用できます。

| カラム | 型 | 説明 |
|--------|------|------|
| `target_year` | INT64 | 年 |
| `target_month` | INT64 | 月 |
| `target_day` | INT64 | 日 |
| `target_day_last_digit` | INT64 | 日の下1桁 (0-9) |
| `is_month_day_repdigit` | BOOL | 月と日がゾロ目か (01/01, 02/02, ..., 12/12) |
| `is_day_repdigit` | BOOL | 日がゾロ目か (11, 22) |
| `day_of_week_jp` | STRING | 曜日（日本語: 月,火,水,木,金,土,日） |
| `day_type` | STRING | 平日/週末/祝日 |

### 祝日判定について

`day_type` は以下の優先順位で判定されます：
1. **週末**: 土曜日または日曜日
2. **祝日**: 日本の祝日（`bqfunc.holidays_in_japan__us.holiday_name()` で判定）
3. **平日**: 上記以外

週末が祝日と重なる場合は「週末」となります。

## 集計期間

### 当日から（当日を含む）

| カラム接頭辞 | 期間 |
|-------------|------|
| d1_ | 当日のみ |
| d2_ | 当日〜1日前（2日間） |
| d3_ | 当日〜2日前（3日間） |
| d4_ | 当日〜3日前（4日間） |
| d5_ | 当日〜4日前（5日間） |
| d6_ | 当日〜5日前（6日間） |
| d7_ | 当日〜6日前（7日間） |
| d14_ | 当日〜13日前（14日間） |
| d28_ | 当日〜27日前（28日間） |
| mtd_ | 当日〜月初 |
| all_ | 当日〜データ開始日（データが存在する過去全て） |

### 前日から（当日を含まない）

| カラム接頭辞 | 期間 |
|-------------|------|
| prev_d1_ | 前日のみ |
| prev_d2_ | 前日〜2日前（2日間） |
| prev_d3_ | 前日〜3日前（3日間） |
| prev_d4_ | 前日〜4日前（4日間） |
| prev_d5_ | 前日〜5日前（5日間） |
| prev_d6_ | 前日〜6日前（6日間） |
| prev_d7_ | 前日〜7日前（7日間） |
| prev_d14_ | 前日〜14日前（14日間） |
| prev_d28_ | 前日〜28日前（28日間） |
| prev_mtd_ | 前日〜月初 |
| prev_all_ | 前日〜データ開始日（データが存在する過去全て） |

## 集計項目

各期間で以下の項目を集計：

| サフィックス | 説明 |
|-------------|------|
| _diff | 総差枚 |
| _game | 総ゲーム数 |
| _win_rate | 勝率 |
| _payout_rate | 機械割（出玉率） |
| _days | 集計日数（all, prev_all のみ） |

## 台番補正

店舗のレイアウト変更に対応するため、以下の台番補正が適用されます。

### アイランド秋葉原店

- **適用期間**: 2025/11/02以前のデータ
- **補正方法**: マッピングテーブルによる変換
- **理由**: 2025/11/03のレイアウト変更により台番が大幅に変更

### エスパス秋葉原駅前店

- **適用期間**: 2025/04/20以前のデータ
- **補正方法**: 2020番台以降の台番に+2
- **理由**: 2025/04/21の増台により台番が2つずれた

## クエリ構造

```sql
WITH deduplicated_data AS (...)     -- 1. 重複排除
machine_number_mapping AS (...)     -- 2. アイランド台番マッピング
normalized_data AS (...)            -- 3. 正規化・台番補正
target_date_def AS (...)            -- 4. 集計日定義
holidays AS (...)                   -- 4.1. 祝日データ（日付カラム用）
current_day_machines AS (...)       -- 5. 当日機種取得
machine_periods AS (...)            -- 6. 機種変更検出
stats_d1 AS (...)                   -- 7. 当日データ
stats_d2, d3, d4, d5, d6, d7, d14, d28, mtd, all AS (...)     -- 8. 当日から過去N日間
stats_prev_d1, d2, d3, d4, d5, d6, d7, d14, d28, mtd, all AS (...) -- 9. 前日から過去N日間
SELECT ...                          -- 10. ソースデータ生成（日付カラム含む）
MERGE INTO ...                      -- 11. UPSERT
```

## 依存関係

- **データソース**: `yobun-450512.slot_data.data_*` テーブル
- **祝日判定**: `bqfunc.holidays_in_japan__us.holiday_name()` 関数
- **宛先**: `yobun-450512.datamart.machine_stats` テーブル
