# 機種別条件別集計クエリ

## 概要

アイランド秋葉原店のスロットデータから、機種ごと・条件ごとの集計データを出力するクエリです。

指定期間中の機種ごとに、以下の条件別で集計を行います：

- 全期間
- 曜日ごと（月～日）
- 平日・土日祝
- 日の下一桁（0～9のつく日）
- 日がゾロ目（11日、22日）
- 月日ゾロ（1/1, 1/11, 2/2, 2/22, ..., 11/11, 12/12）
- 月周年日（毎月20日）
- 月初（毎月1日）
- 月末

## 使い方

### BigQueryでの実行

1. BigQueryコンソールで `machine_summary.sql` を開く
2. パラメータを設定
3. クエリを実行

### パラメータ

| パラメータ名 | 型 | 説明 | 例 |
|------------|------|------|------|
| `@DATE_FROM` | STRING | 集計開始日（YYYYMMDD形式） | `20250101` |
| `@DATE_TO` | STRING | 集計終了日（YYYYMMDD形式） | `20250131` |

### パラメータ設定例

#### BigQueryコンソールでの設定

```sql
DECLARE DATE_FROM STRING DEFAULT '20250101';
DECLARE DATE_TO STRING DEFAULT '20250131';
```

または、クエリエディタの「パラメータ」タブから設定：

- `@DATE_FROM`: `20250101`
- `@DATE_TO`: `20250131`

#### コマンドラインでの実行

**標準出力（テーブル形式）:**
```bash
bq query \
  --use_legacy_sql=false \
  --parameter=DATE_FROM:STRING:20240101 \
  --parameter=DATE_TO:STRING:20250131 \
  < machine_summary.sql
```

**CSV形式で出力:**
```bash
bq query \
  --use_legacy_sql=false \
  --format=csv \
  --parameter=DATE_FROM:STRING:20240101 \
  --parameter=DATE_TO:STRING:20250131 \
  < machine_summary.sql > output.csv
```

**CSVファイルに直接保存（ヘッダー付き）:**
```bash
bq query \
  --use_legacy_sql=false \
  --format=csv \
  --parameter=DATE_FROM:STRING:20240101 \
  --parameter=DATE_TO:STRING:20250131 \
  "$(cat machine_summary.sql)" > machine_summary_20240101_20250131.csv
```

## 出力形式

### CSVオプション

`bq query`コマンドで利用可能な出力形式：

| オプション | 説明 |
|-----------|------|
| `--format=prettyjson` | JSON形式（整形済み） |
| `--format=json` | JSON形式（1行） |
| `--format=csv` | CSV形式（カンマ区切り） |
| `--format=table` | テーブル形式（デフォルト） |

**大きな結果セットの場合:**

```bash
# BigQueryの宛先テーブルに保存してからエクスポート
bq query \
  --use_legacy_sql=false \
  --destination_table=yobun-450512:temp.machine_summary_result \
  --replace \
  --parameter=DATE_FROM:STRING:20240101 \
  --parameter=DATE_TO:STRING:20250131 \
  "$(cat machine_summary.sql)"

# GCSにエクスポート
bq extract \
  --destination_format=CSV \
  yobun-450512:temp.machine_summary_result \
  gs://your-bucket/machine_summary_*.csv
```

## 出力カラム

| カラム名 | 型 | 説明 |
|---------|------|------|
| `condition_type` | STRING | 条件カテゴリ |
| `condition_value` | STRING | 条件値 |
| `machine` | STRING | 機種名 |
| `period_from` | STRING | 集計期間開始日（その機種の最初のデータ日付） |
| `period_to` | STRING | 集計期間終了日（その機種の最後のデータ日付） |
| `sample_days` | INT64 | サンプル日数（ユニークな日付数） |
| `sample_units` | INT64 | サンプル台数（データ行数） |
| `total_diff` | INT64 | 合計差枚 |
| `avg_diff` | FLOAT64 | 平均差枚 |
| `total_game` | INT64 | 総回転数 |
| `win_rate` | FLOAT64 | 勝率（0.0～1.0） |
| `payout_rate` | FLOAT64 | 出率（0.0～2.0程度） |

### 条件カテゴリ一覧

| condition_type | 説明 | condition_value の例 |
|---------------|------|----------------------|
| `全期間` | 全期間 | `全期間` |
| `曜日` | 曜日ごと | `月`, `火`, `水`, `木`, `金`, `土`, `日` |
| `日種別` | 平日・土日祝 | `平日`, `土日祝` |
| `下一桁` | 日の下一桁 | `0のつく日`, `1のつく日`, ..., `9のつく日` |
| `日ゾロ目` | 日がゾロ目 | `ゾロ目日(11,22)` |
| `月日ゾロ` | 月日ゾロ | `月日ゾロ` |
| `周年日` | 月周年日 | `月周年日(20日)` |
| `月初` | 月初 | `月初(1日)` |
| `月末` | 月末 | `月末` |

## 出力例

```
+----------------+------------------+----------------------+-------------+-------------+-------------+--------------+------------+----------+------------+----------+--------------+
| condition_type | condition_value  | machine              | period_from | period_to   | sample_days | sample_units | total_diff | avg_diff | total_game | win_rate | payout_rate  |
+----------------+------------------+----------------------+-------------+-------------+-------------+--------------+------------+----------+------------+----------+--------------+
| 全期間         | 全期間           | Lスマスロ北斗の拳    | 2025-01-01  | 2025-01-31  | 31          | 372          | -45000     | -120.97  | 280000     | 0.43     | 0.9464       |
| 曜日           | 月               | Lスマスロ北斗の拳    | 2025-01-06  | 2025-01-27  | 4           | 48           | -6000      | -125.00  | 35000      | 0.41     | 0.9428       |
| 曜日           | 火               | Lスマスロ北斗の拳    | 2025-01-07  | 2025-01-28  | 4           | 48           | -4500      | -93.75   | 38000      | 0.45     | 0.9605       |
| 日種別         | 平日             | Lスマスロ北斗の拳    | 2025-01-02  | 2025-01-31  | 22          | 264          | -32000     | -121.21  | 195000     | 0.42     | 0.9452       |
| 日種別         | 土日祝           | Lスマスロ北斗の拳    | 2025-01-01  | 2025-01-26  | 9           | 108          | -13000     | -120.37  | 85000      | 0.46     | 0.9490       |
| 下一桁         | 0のつく日        | Lスマスロ北斗の拳    | 2025-01-10  | 2025-01-30  | 3           | 36           | -3800      | -105.56  | 28000      | 0.47     | 0.9544       |
+----------------+------------------+----------------------+-------------+-------------+-------------+--------------+------------+----------+------------+----------+--------------+
```

## 実装の詳細

### 台番補正

アイランド秋葉原店の台番変更（2025/11/02以前→以降）を自動的に補正します。

### 祝日判定

日本の祝日は `bqfunc.holidays_in_japan__us.holiday_name()` 関数を使用して判定します。

### 月日ゾロの定義

以下の2つのパターンを含みます：

1. 月と日が同じ：1/1, 2/2, 3/3, ..., 12/12
2. 月と日がゾロ目で一致：1/11, 2/22（月×11=日）

これにより、以下の日付が該当します：

- 1/1, 1/11
- 2/2, 2/22
- 3/3
- 4/4
- 5/5
- 6/6
- 7/7
- 8/8
- 9/9
- 10/10
- 11/11
- 12/12

### データフィルタリング

- ゲーム数が0またはNULLのデータは集計から除外
- タイムスタンプが最新のデータのみを使用（重複排除）

### 集計指標

#### 出率の計算式

```
出率 = (総ゲーム数 × 3枚 + 合計差枚) ÷ (総ゲーム数 × 3枚)
```

- 3枚は1回転あたりの投入枚数
- 出率 > 1.0: 客側がプラス
- 出率 < 1.0: 店側がプラス
- 出率 = 1.0: 収支トントン

#### 勝率の計算

```
勝率 = プラス台数 ÷ 総台数
```

- `win` フラグが1の台数を合計し、全台数で割る

## 注意事項

### 機種変更について

同じ台番でも機種が変わった場合、別の機種として集計されます。これは `machine` カラムで `GROUP BY` しているためです。

### 集計期間について

`period_from` と `period_to` は、その機種のデータが実際に存在する最初と最後の日付を示します。

- **撤去済み機種**: 指定期間内であっても、撤去日がその機種の `period_to` になります
- **新台導入**: 指定期間内であっても、導入日がその機種の `period_from` になります
- **条件別集計**: 曜日ごと、特定日などの条件別では、その条件に該当する最初と最後の日付が表示されます

例：
- 全期間: `period_from: 2025-01-01, period_to: 2025-01-31` (機種全体の設置期間)
- 月曜日のみ: `period_from: 2025-01-06, period_to: 2025-01-27` (期間内の最初と最後の月曜日)

### サンプルサイズについて

条件によってはサンプル数が少なくなる場合があります：

- **ゾロ目日**: 月に最大2日（11日、22日）
- **月日ゾロ**: 年間12～14日程度
- **月周年日**: 月に1日（20日）
- **月初**: 月に1日（1日）
- **月末**: 月に1日（28～31日）

サンプルサイズが小さい場合、統計的な信頼性が低くなることに注意してください。

### パフォーマンス

- 大量のデータを扱うため、実行には時間がかかる場合があります
- テーブルスキャン量を抑えるため、期間を適切に設定してください

## クエリのカスタマイズ

### 他店舗への対応

`params` CTEで店舗を変更できます：

```sql
WITH params AS (
  SELECT
    CAST(@DATE_FROM AS STRING) AS date_from,
    CAST(@DATE_TO AS STRING) AS date_to,
    'エスパス秋葉原駅前店' AS hole  -- 店舗を変更
),
```

ただし、台番マッピングも店舗に応じて調整が必要な場合があります。

### 条件の追加

新しい条件を追加する場合：

1. `base_data` CTEに条件フラグを追加
2. 新しい集計CTE（`agg_xxx`）を作成
3. 最後の `UNION ALL` に追加

例：5のつく日と6のつく日を統合

```sql
agg_56_days AS (
  SELECT
    '5と6' AS condition_type,
    '5と6のつく日' AS condition_value,
    machine,
    COUNT(DISTINCT date) AS sample_days,
    COUNT(*) AS sample_units,
    SUM(diff) AS total_diff,
    SAFE_DIVIDE(SUM(diff), COUNT(*)) AS avg_diff,
    SUM(game) AS total_game,
    SAFE_DIVIDE(SUM(win), COUNT(*)) AS win_rate,
    SAFE_DIVIDE(SUM(game) * 3 + SUM(diff), SUM(game) * 3) AS payout_rate
  FROM filtered_data
  WHERE last_digit IN ('5', '6')
  GROUP BY machine
)
```

## 関連クエリ

- [heatmap_query.sql](../../../heatmap/heatmap_query.sql): 台番別のヒートマップ用集計
- [machine_stats/query.sql](../../../datamart/machine_stats/query.sql): 日次の機種統計データマート

## 更新履歴

- 2026-01-20: 初版作成
